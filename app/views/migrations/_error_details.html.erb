

<% if @migration.last_error.present? %>
  <% error_context = MigrationErrorHelper.explain_error(@migration) %>

  <% if error_context %>
    <%
      severity = error_context[:severity]
      if severity == :critical
        severity_bg_class    = "bg-danger-subtle"
        severity_border_class = "border-start border-4 border-danger"
        severity_text_class  = "text-danger-emphasis"
        alert_class          = "alert-danger"
      elsif severity == :error
        severity_bg_class    = "bg-warning-subtle"
        severity_border_class = "border-start border-4 border-warning"
        severity_text_class  = "text-warning-emphasis"
        alert_class          = "alert-warning"
      else
        severity_bg_class    = "bg-warning-subtle"
        severity_border_class = "border-start border-4 border-warning"
        severity_text_class  = "text-warning-emphasis"
        alert_class          = "alert-warning"
      end
    %>
    <div class="error-details-section mb-5">
      <%# Error Header %>
      <div class="error-header <%= severity_bg_class %> <%= severity_border_class %> p-4 rounded-3 mb-3">
        <h3 class="<%= severity_text_class %> fs-5 fw-bold mb-2 d-flex align-items-center gap-2">
          <span class="fs-4"><%= error_context[:icon] %></span>
          <%= error_context[:title] %>
        </h3>

        <%# Current Status %>
        <div class="bg-white bg-opacity-75 p-3 rounded-2 mb-3">
          <div class="small fw-semibold <%= severity_text_class %> mb-1">
            Current Status:
          </div>
          <div class="small text-dark">
            <%= error_context[:current_status] %>
          </div>

          <%# Retry Information (only shown for errors with automatic retries) %>
          <% if error_context[:retry_info] && error_context[:retry_info][:remaining] > 0 %>
            <div class="mt-2 p-2 bg-info-subtle rounded-2">
              <div class="small text-primary">
                <strong>‚è±Ô∏è Retry Attempt:</strong> <%= error_context[:retry_info][:attempt] %> / <%= error_context[:retry_info][:max_attempts] %>
                <br>
                <strong>Remaining Attempts:</strong> <%= error_context[:retry_info][:remaining] %>
              </div>
              <div id="retry-countdown" class="mt-1 text-primary" style="font-size: 12px;">
                Next retry in <span id="countdown-timer">calculating...</span>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <%# Re-authentication form - shown when credentials have expired but migration data is intact %>
      <% if error_context[:show_reauth_form] %>
        <div class="bg-info-subtle border border-2 border-primary rounded-3 p-4 mb-3">
          <h4 class="text-primary fw-bold mb-2" style="font-size: 16px;">
            Your migration data is safe ‚Äî just re-enter your password to continue.
          </h4>
          <p class="text-primary small mb-3">
            Enter your password for <strong><%= @migration.old_handle %></strong> to restore your session and continue the migration.
          </p>
          <form action="<%= reauthenticate_by_token_path(@migration.token) %>" method="post">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
            <div class="mb-3">
              <label for="reauth_password" class="form-label small text-primary fw-semibold mb-1">
                Password for <%= @migration.old_handle %>
              </label>
              <input type="password" name="password" id="reauth_password" required
                     autocomplete="current-password"
                     placeholder="Enter your account password"
                     class="form-control">
            </div>
            <button type="submit" class="btn btn-lg btn-gradient">
              Re-authenticate & Continue Migration
            </button>
          </form>
        </div>
      <% end %>

      <%# PLC Token Action - shown when a new PLC token is needed %>
      <% if error_context[:show_request_new_plc_token] %>
        <div class="bg-info-subtle border border-2 border-primary rounded-3 p-4 mb-3">
          <h4 class="text-primary fw-bold mb-2" style="font-size: 16px;">
            Your migration data is safe ‚Äî you just need a fresh PLC token.
          </h4>

          <% if @migration.has_old_pds_tokens? %>
            <%# Old PDS session is still valid ‚Äî can request token automatically %>
            <p class="text-primary small mb-3">
              Click the button below to request a new PLC token. You'll receive it via email from <strong><%= @migration.old_pds_host %></strong>.
            </p>
            <form action="<%= request_new_plc_token_by_token_path(@migration.token) %>" method="post" class="d-inline">
              <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
              <button type="submit"
                      onclick="return confirm('Request a new PLC token from your old PDS?');"
                      class="btn btn-lg btn-gradient">
                Request New PLC Token
              </button>
            </form>
          <% else %>
            <%# Old PDS session expired ‚Äî need password to re-authenticate %>
            <p class="text-primary small mb-3">
              Your session with <strong><%= @migration.old_pds_host %></strong> has expired.
              Enter your password for <strong><%= @migration.old_handle %></strong> to re-connect and request a new PLC token.
            </p>
            <form action="<%= reauthenticate_by_token_path(@migration.token) %>" method="post">
              <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
              <div class="mb-3">
                <label for="reauth_plc_password" class="form-label small text-primary fw-semibold mb-1">
                  Password for <%= @migration.old_handle %>
                </label>
                <input type="password" name="password" id="reauth_plc_password" required
                       autocomplete="current-password"
                       placeholder="Enter your account password"
                       class="form-control">
              </div>
              <button type="submit" class="btn btn-lg btn-gradient">
                Re-authenticate & Request PLC Token
              </button>
            </form>
          <% end %>
        </div>
      <% end %>

      <%# Expandable Details %>
      <details class="error-expandable mb-3">
        <summary class="p-3 bg-light rounded-2 fw-semibold text-dark small" style="cursor: pointer; user-select: none;">
          üìã What Happened & What To Do
        </summary>

        <div class="p-4 bg-white border rounded-2 mt-2">
          <%# What Happened %>
          <div class="mb-4">
            <h4 class="text-dark fw-bold mb-2" style="font-size: 16px;">
              What Happened:
            </h4>
            <p class="text-body-secondary small lh-lg">
              <%= error_context[:what_happened] %>
            </p>
          </div>

          <%# What To Do %>
          <div class="mb-4">
            <h4 class="text-dark fw-bold mb-2" style="font-size: 16px;">
              What You Can Do:
            </h4>
            <ul class="text-body-secondary small lh-lg ps-4">
              <% error_context[:what_to_do].each do |action| %>
                <li class="mb-1"><%= action %></li>
              <% end %>
            </ul>
          </div>

          <%# Action Buttons %>
          <div class="d-flex flex-wrap gap-2 mt-4 pt-4 border-top">
            <% if error_context[:show_request_new_plc_token] %>
              <%= button_to "üìß Request New PLC Token", request_new_plc_token_by_token_path(@migration.token),
                  method: :post,
                  data: { confirm: "Request a new PLC token from your old PDS provider?" },
                  class: "btn btn-gradient d-inline-flex align-items-center gap-1" %>
            <% end %>

            <% if error_context[:show_retry_button] %>
              <%= button_to "üîÑ Retry Migration", retry_migration_by_token_path(@migration.token),
                  method: :post,
                  data: { confirm: "Retry this migration from the current stage?" },
                  class: "btn btn-gradient d-inline-flex align-items-center gap-1" %>
            <% end %>

            <% if error_context[:show_new_migration_button] %>
              <%= link_to "‚ûï Start New Migration", new_migration_path,
                  class: "btn btn-success d-inline-flex align-items-center gap-1" %>
            <% end %>

            <% if error_context[:check_url] %>
              <%= link_to "üîç Check PDS Status", error_context[:check_url],
                  target: "_blank",
                  rel: "noopener noreferrer",
                  class: "btn btn-secondary d-inline-flex align-items-center gap-1" %>
            <% end %>

            <% if error_context[:show_download_manifest] && @migration.progress_data&.dig('failed_blobs').present? %>
              <%= link_to "üìÑ Download Failed Blobs Report", export_recovery_data_migration_by_token_path(@migration.token, format: :txt),
                  class: "btn btn-warning d-inline-flex align-items-center gap-1" %>
            <% end %>

          </div>

          <%# Special Sections %>
          <% if error_context[:show_cleanup_instructions] %>
            <div class="mt-4 p-3 bg-warning-subtle border-start border-4 border-warning rounded-2">
              <h4 class="text-warning-emphasis fw-bold mb-2" style="font-size: 15px;">
                üõ†Ô∏è Cleanup Instructions
              </h4>
              <p class="text-warning-emphasis small mb-2">
                To clean up the orphaned account, run this command (requires server access):
              </p>
              <code class="d-block bg-white bg-opacity-75 p-3 rounded-2 font-monospace" style="font-size: 12px; overflow-wrap: break-word;">
                cd scripts && ./cleanup_orphaned_account_db.sh <%= error_context[:did] %>
              </code>
              <p class="text-warning-emphasis small mt-2 mb-0">
                Or contact the target PDS administrator to manually delete the orphaned account.
              </p>
            </div>
          <% end %>

          <% if error_context[:show_rotation_key] && @migration.rotation_key.present? %>
            <div class="mt-4 p-3 bg-danger-subtle border-start border-4 border-danger rounded-2">
              <h4 class="text-danger-emphasis fw-bold mb-2" style="font-size: 15px;">
                üîë Your Rotation Key (SAVE THIS)
              </h4>
              <div class="bg-white p-3 rounded-2 my-2 font-monospace" style="font-size: 11px; overflow-wrap: break-word; word-break: break-all;">
                <%= @migration.rotation_key %>
              </div>
              <button onclick="navigator.clipboard.writeText('<%= j @migration.rotation_key %>'); this.textContent='‚úÖ Copied!'; setTimeout(() => this.textContent='üìã Copy Rotation Key', 2000)"
                      class="btn btn-sm btn-danger fw-semibold">
                üìã Copy Rotation Key
              </button>
            </div>
          <% end %>

          <% if error_context[:show_contact_support] %>
            <div class="mt-4 p-3 bg-danger-subtle border-start border-4 border-danger rounded-2">
              <h4 class="text-danger-emphasis fw-bold mb-2" style="font-size: 15px;">
                üö® Contact Support Immediately
              </h4>
              <p class="text-danger-emphasis small mb-2">
                <strong>Support Email:</strong> <%= error_context[:support_email] %><br>
                <strong>Migration Token:</strong> <code class="bg-white bg-opacity-75 px-1 rounded-1"><%= error_context[:migration_token] %></code>
              </p>
              <p class="text-danger-emphasis small mb-0">
                Include your migration token in your support request for faster assistance.
              </p>
            </div>
          <% end %>
        </div>
      </details>

      <%# Technical Details (Collapsed by Default) %>
      <details class="technical-details mb-3">
        <summary class="p-3 bg-light rounded-2 fw-semibold text-muted small" style="cursor: pointer; user-select: none;">
          üîß Technical Details (For Debugging)
        </summary>

        <div class="p-3 rounded-2 mt-2 font-monospace" style="background: #1f2937; color: #f3f4f6; font-size: 12px; overflow-x: auto;">
          <div class="mb-2">
            <strong class="text-secondary">Error Message:</strong>
          </div>
          <div class="p-2 rounded-2" style="background: rgba(0,0,0,0.3); white-space: pre-wrap; word-break: break-word;"><%= error_context[:technical_details] %></div>

          <% if error_context[:job_step] %>
            <div class="mt-3">
              <strong class="text-secondary">Job Step:</strong> <%= error_context[:job_step] %>
            </div>
          <% end %>

          <div class="mt-3">
            <strong class="text-secondary">Migration Status:</strong> <%= @migration.status %>
          </div>

          <div class="mt-2">
            <strong class="text-secondary">Migration Token:</strong> <%= @migration.token %>
          </div>

          <div class="mt-2">
            <strong class="text-secondary">DID:</strong> <%= @migration.did %>
          </div>
        </div>
      </details>
    </div>

    <%# Auto-refresh countdown script (only when retry info is present) %>
    <% if error_context[:retry_info] %>
    <script>
      (function() {
        // Estimated retry countdown (approximation based on exponential backoff)
        const attempt = <%= error_context[:retry_info][:attempt] || 0 %>;
        const maxAttempts = <%= error_context[:retry_info][:max_attempts] || 3 %>;

        if (attempt > 0 && attempt < maxAttempts) {
          // Exponential backoff estimate: 2^attempt seconds
          let remainingSeconds = Math.pow(2, attempt);

          const countdownEl = document.getElementById('countdown-timer');
          if (countdownEl) {
            const updateCountdown = () => {
              if (remainingSeconds > 0) {
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;

                if (minutes > 0) {
                  countdownEl.textContent = `${minutes}m ${seconds}s`;
                } else {
                  countdownEl.textContent = `${seconds}s`;
                }

                remainingSeconds--;
                setTimeout(updateCountdown, 1000);
              } else {
                countdownEl.textContent = 'retrying now...';
              }
            };

            updateCountdown();
          }
        }
      })();
    </script>
    <% end %>
  <% end %>
<% end %>
