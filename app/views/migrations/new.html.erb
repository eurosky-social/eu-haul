<% content_for :title do %><%= EuroskyConfig::SITE_NAME %> - Start Account Migration<% end %>

<% content_for :head do %>
<style>
  body {
    margin: 0;
    padding: 0;
    <% if EuroskyConfig::BACKGROUND_IMAGE_URL.present? %>
    background: url('<%= EuroskyConfig::BACKGROUND_IMAGE_URL %>') no-repeat center center fixed;
    background-size: cover;
    <% else %>
    background: var(--gradient);
    <% end %>
    display: flex;
    align-items: center;
    justify-content: center;
  }

  <% if EuroskyConfig::BACKGROUND_IMAGE_URL.present? %>
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    z-index: 0;
  }
  <% end %>

  .new-migration-container {
    position: relative;
    z-index: 1;
    max-width: 700px;
    width: 90%;
    margin: 40px auto;
  }

  .new-migration-content {
    background: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(20px) saturate(180%);
    border-radius: 24px;
    padding: 48px;
    padding-top: 0;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .new-migration-header {
    text-align: center;
    margin-bottom: 24px;
    padding: 24px 48px;
    background: #ffffff;
    border-radius: 12px;
  }

  .new-migration-header h1 {
    font-size: 72px;
    font-weight: 900;
    color: #000000;
    margin: 0 0 8px 0;
    letter-spacing: -2px;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Arial Black", sans-serif;
  }

  .new-migration-header p {
    font-size: 14px;
    color: #000000;
    margin: 0;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .handle-suffix {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
    pointer-events: none;
  }
</style>
<% end %>

<% content_for :scripts do %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');

    // Form fields
    const handleField = document.getElementById('migration_old_handle');
    const passwordField = document.getElementById('migration_password');
    const emailField = document.getElementById('migration_email');
    const pdsSelect = document.getElementById('pds-select');
    const customPdsField = document.getElementById('migration_new_pds_host');
    const inviteCodeField = document.getElementById('migration_invite_code');

    // Steps
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const step3 = document.getElementById('step-3');
    const step4 = document.getElementById('step-4');
    const step5 = document.getElementById('step-5');

    // Wizard state
    let wizardData = {
      email: null,
      emailReadonly: false,
      authenticated: false,
      pdsHost: null,
      pdsVerified: false,
      pdsVerifiedHost: null,
      availableDomains: [],
      handleType: null,
      canPreserveHandle: false,
      oldHandle: null,
      handleVerifiedVia: null
    };

    // Progress indicators
    const progress1 = document.getElementById('progress-1');
    const progress2 = document.getElementById('progress-2');
    const progress3 = document.getElementById('progress-3');
    const progress4 = document.getElementById('progress-4');
    const progress5 = document.getElementById('progress-5');

    // Configuration from server
    const defaultTargetPds = '<%= EuroskyConfig::DEFAULT_TARGET_PDS %>';

    // Initialize
    showStep(1);

    // Pre-select default target PDS if configured
    if (defaultTargetPds && pdsSelect) {
      const option = Array.from(pdsSelect.options).find(opt => opt.value === defaultTargetPds);
      if (option) {
        pdsSelect.value = defaultTargetPds;
        customPdsField.value = defaultTargetPds;
      }
    }

    // Show/hide steps
    function showStep(stepNumber) {
      [step1, step2, step3, step4, step5].forEach(s => s.classList.remove('active'));
      [progress1, progress2, progress3, progress4, progress5].forEach(p => p.classList.remove('active', 'completed'));

      if (stepNumber === 1) {
        step1.classList.add('active');
        progress1.classList.add('active');
      }
      if (stepNumber === 2) {
        step2.classList.add('active');
        progress1.classList.add('completed');
        progress2.classList.add('active');
      }
      if (stepNumber === 3) {
        step3.classList.add('active');
        progress1.classList.add('completed');
        progress2.classList.add('completed');
        progress3.classList.add('active');
      }
      if (stepNumber === 4) {
        step4.classList.add('active');
        progress1.classList.add('completed');
        progress2.classList.add('completed');
        progress3.classList.add('completed');
        progress4.classList.add('active');
      }
      if (stepNumber === 5) {
        step5.classList.add('active');
        [progress1, progress2, progress3, progress4].forEach(p => p.classList.add('completed'));
        progress5.classList.add('active');
      }
    }

    // Utility: Show status message
    function showStatus(element, message, type) {
      element.textContent = message;
      element.className = 'lookup-status lookup-' + type + ' mt-3';
      element.style.display = 'block';
    }

    // STEP 1: Handle & Password
    document.getElementById('step1-next').addEventListener('click', function(e) {
      e.preventDefault();

      const handle = handleField.value.trim();
      const password = passwordField.value.trim();
      const btn = e.target;
      const status = document.getElementById('step1-status');

      if (!handle) {
        showStatus(status, 'Please enter a handle', 'error');
        return;
      }

      if (!password) {
        showStatus(status, 'Please enter your password', 'error');
        return;
      }

      if (!handle.includes('.')) {
        showStatus(status, 'Handle must include a domain (e.g., user.bsky.social)', 'error');
        return;
      }

      // If already authenticated and fields are readonly, proceed to step 2
      if (wizardData.authenticated) {
        showStep(2);
        setupStep2();
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Authenticating...';
      showStatus(status, 'Authenticating and fetching your account details...', 'info');

      fetch('/migrations/lookup_handle', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          handle: handle,
          password: password,
          two_factor_code: document.getElementById('two_factor_code').value.trim() || undefined
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.two_factor_required) {
          document.getElementById('two-factor-group').style.display = 'block';
          document.getElementById('two_factor_code').focus();
          showStatus(status, 'A sign-in code has been sent to your email. Enter it above and click Continue again.', 'info');
          btn.disabled = false;
          btn.textContent = 'Continue';
          return;
        }

        if (data.error) {
          showStatus(status, data.error, 'error');
          btn.disabled = false;
          btn.textContent = 'Continue';
          return;
        }

        showStatus(status, 'Authentication successful!', 'success');

        // Store email data and mark as authenticated
        wizardData.authenticated = true;
        if (data.email) {
          wizardData.email = data.email;
          wizardData.emailReadonly = true;
        } else {
          wizardData.email = '';
          wizardData.emailReadonly = false;
        }

        // Store DID, source PDS, and authentication tokens
        wizardData.did = data.did;
        wizardData.oldPdsHost = data.pds_host;
        wizardData.accessToken = data.access_token;
        wizardData.refreshToken = data.refresh_token;

        // Store handle type information for step 4
        wizardData.handleType = data.handle_type || 'pds_hosted';
        wizardData.canPreserveHandle = data.can_preserve_handle || false;
        wizardData.oldHandle = handle;
        wizardData.handleVerifiedVia = data.handle_verified_via;

        // Proceed to step 2
        setTimeout(() => {
          handleField.readOnly = true;
          passwordField.readOnly = true;
          btn.disabled = false;
          btn.textContent = 'Continue';
          showStep(2);
          setupStep2();
        }, 500);
      })
      .catch(error => {
        showStatus(status, 'Network error. Please try again.', 'error');
        btn.disabled = false;
        btn.textContent = 'Continue';
      });
    });

    // STEP 2: Email
    function setupStep2() {
      emailField.value = wizardData.email || '';
      if (wizardData.emailReadonly) {
        emailField.readOnly = true;
        emailField.classList.add('readonly-field');
        document.querySelector('#step-2 .form-text').textContent = 'Email retrieved from your account';
      } else {
        emailField.readOnly = false;
        emailField.classList.remove('readonly-field');
        document.querySelector('#step-2 .form-text').textContent = 'We couldn\'t retrieve your email. Please enter it manually.';
        emailField.focus();
      }
    }

    document.getElementById('step2-back').addEventListener('click', function(e) {
      e.preventDefault();
      handleField.readOnly = false;
      passwordField.readOnly = false;
      handleField.classList.remove('readonly-field');
      passwordField.classList.remove('readonly-field');
      wizardData.authenticated = false;
      showStep(1);
    });

    document.getElementById('step2-next').addEventListener('click', function(e) {
      e.preventDefault();

      const email = emailField.value.trim();
      if (!email) {
        alert('Please enter your email address');
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert('Please enter a valid email address');
        return;
      }

      const confirmCheckbox = document.getElementById('confirm-email-access');
      if (!confirmCheckbox.checked) {
        alert('Please confirm that you have access to this email address.');
        confirmCheckbox.focus();
        return;
      }

      wizardData.email = email;
      emailField.readOnly = true;
      showStep(3);
      setupStep3();
    });

    // STEP 3: PDS Selection
    function setupStep3() {
      if (defaultTargetPds && pdsSelect.value === defaultTargetPds) {
        const status = document.getElementById('pds-status');
        const inviteGroup = document.getElementById('invite-code-group');
        checkPdsRequirements(defaultTargetPds, status, inviteGroup, function(success) {
          if (success) {
            checkAccountExistsOnTarget(defaultTargetPds, function(exists) {
              if (exists) {
                showTargetPasswordSection(defaultTargetPds);
              }
            });
          }
        });
      }
    }

    document.getElementById('step3-back').addEventListener('click', function(e) {
      e.preventDefault();
      if (!wizardData.emailReadonly) {
        emailField.readOnly = false;
      }
      showStep(2);
    });

    document.getElementById('step3-next').addEventListener('click', function(e) {
      e.preventDefault();

      const btn = e.target;
      const status = document.getElementById('pds-status');
      const inviteGroup = document.getElementById('invite-code-group');
      let selectedPds = pdsSelect.value;

      if (selectedPds === 'custom') {
        selectedPds = customPdsField.value.trim();
      }

      if (!selectedPds || selectedPds === 'custom') {
        alert('Please select a Server or enter a custom Server URL');
        return;
      }

      // For custom PDS: if not yet verified, check requirements first
      if (pdsSelect.value === 'custom' && (!wizardData.pdsVerified || wizardData.pdsVerifiedHost !== selectedPds)) {
        btn.disabled = true;
        btn.textContent = 'Checking Server...';
        checkPdsRequirements(selectedPds, status, inviteGroup, function(success) {
          if (!success) {
            btn.disabled = false;
            btn.textContent = 'Continue';
            return;
          }

          // After PDS check succeeds, check if account already exists on target
          btn.textContent = 'Checking for existing account...';
          checkAccountExistsOnTarget(selectedPds, function(exists) {
            btn.disabled = false;
            btn.textContent = 'Continue';
            if (exists) {
              showTargetPasswordSection(selectedPds);
              // Stay on step 3 for credential entry
            } else if (inviteCodeField.required) {
              hideTargetPasswordSection();
              showStatus(status, 'This Server requires an invite code. Please enter it below, then click Continue.', 'info');
              inviteCodeField.focus();
            } else {
              hideTargetPasswordSection();
              wizardData.pdsHost = selectedPds;
              showStep(4);
              setupStep4();
            }
          });
        });
        return;
      }

      // Check if invite code is required and empty (only for migration_out)
      if (!wizardData.accountExistsOnTarget && inviteCodeField.required && !inviteCodeField.value.trim()) {
        showStatus(status, 'Please enter an invite code to continue.', 'error');
        inviteCodeField.focus();
        return;
      }

      // If account exists on target, verify credentials before proceeding
      if (wizardData.accountExistsOnTarget) {
        const targetPassword = document.getElementById('target-pds-password').value.trim();
        const targetStatus = document.getElementById('target-password-status');

        if (!targetPassword) {
          showStatus(targetStatus, 'Please enter your password for this server', 'error');
          return;
        }

        if (wizardData.targetCredentialsVerified) {
          wizardData.pdsHost = selectedPds;
          showStep(4);
          setupStep4();
          return;
        }

        btn.disabled = true;
        btn.textContent = 'Verifying credentials...';
        showStatus(targetStatus, 'Authenticating with your existing account...', 'info');

        fetch('/migrations/verify_target_credentials', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({
            pds_host: selectedPds,
            did: wizardData.did,
            password: targetPassword,
            two_factor_code: document.getElementById('target-2fa-code').value.trim() || undefined
          })
        })
        .then(response => response.json())
        .then(data => {
          btn.disabled = false;
          btn.textContent = 'Continue';

          if (data.two_factor_required) {
            document.getElementById('target-2fa-group').style.display = 'block';
            document.getElementById('target-2fa-code').focus();
            showStatus(targetStatus, 'A sign-in code has been sent to your email. Enter it above and click Continue again.', 'info');
            return;
          }

          if (data.error) {
            showStatus(targetStatus, data.error, 'error');
            return;
          }

          wizardData.targetCredentialsVerified = true;
          wizardData.newPdsAccessToken = data.access_token;
          wizardData.newPdsRefreshToken = data.refresh_token;

          showStatus(targetStatus, 'Credentials verified!', 'success');

          setTimeout(() => {
            wizardData.pdsHost = selectedPds;
            showStep(4);
            setupStep4();
          }, 500);
        })
        .catch(error => {
          btn.disabled = false;
          btn.textContent = 'Continue';
          showStatus(targetStatus, 'Network error. Please try again.', 'error');
        });
        return;
      }

      wizardData.pdsHost = selectedPds;
      showStep(4);
      setupStep4();
    });

    // Check if account already exists on target PDS (replaces old bsky.social-only isMigrationIn check)
    function checkAccountExistsOnTarget(pdsUrl, callback) {
      if (!pdsUrl || !wizardData.did) {
        callback(false);
        return;
      }

      fetch('/migrations/check_did_on_pds', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          did: wizardData.did,
          pds_host: pdsUrl
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.exists) {
          wizardData.accountExistsOnTarget = true;
          wizardData.accountDeactivatedOnTarget = data.deactivated || false;
          wizardData.targetPdsSupportEmail = data.support_email || null;
          wizardData.existingHandleOnTarget = data.handle || null;
          callback(true, data);
        } else {
          wizardData.accountExistsOnTarget = false;
          wizardData.accountDeactivatedOnTarget = false;
          wizardData.targetPdsSupportEmail = null;
          wizardData.existingHandleOnTarget = null;
          callback(false, data);
        }
      })
      .catch(error => {
        // On error, assume account doesn't exist (proceed with migration_out)
        wizardData.accountExistsOnTarget = false;
        wizardData.accountDeactivatedOnTarget = false;
        wizardData.existingHandleOnTarget = null;
        callback(false);
      });
    }

    function showTargetPasswordSection(pdsUrl) {
      const targetPasswordGroup = document.getElementById('target-password-group');
      const targetPasswordStatus = document.getElementById('target-password-status');
      const deactivatedHelp = document.getElementById('target-deactivated-help');
      const deactivatedPwdLink = document.getElementById('target-deactivated-pwd-link');
      const deactivatedSupportEmail = document.getElementById('target-deactivated-support-email');
      const deactivatedDid = document.getElementById('target-deactivated-did');

      // Hide invite code section - not needed when using existing account
      const inviteGroup = document.getElementById('invite-code-group');
      if (inviteGroup) inviteGroup.style.display = 'none';

      targetPasswordGroup.style.display = 'block';
      wizardData.targetCredentialsVerified = false;
      wizardData.newPdsAccessToken = null;
      wizardData.newPdsRefreshToken = null;
      targetPasswordStatus.style.display = 'none';

      // Show deactivated account help if applicable
      if (deactivatedHelp) {
        if (wizardData.accountDeactivatedOnTarget) {
          deactivatedHelp.style.display = 'block';
          if (deactivatedPwdLink) {
            deactivatedPwdLink.href = pdsUrl.replace(/\/$/, '') + '/.well-known/change-password';
            deactivatedPwdLink.textContent = pdsUrl.replace(/\/$/, '') + '/.well-known/change-password';
          }
          if (deactivatedSupportEmail && wizardData.targetPdsSupportEmail) {
            deactivatedSupportEmail.href = 'mailto:' + wizardData.targetPdsSupportEmail;
            deactivatedSupportEmail.textContent = wizardData.targetPdsSupportEmail;
          }
          if (deactivatedDid) {
            deactivatedDid.textContent = wizardData.did;
          }
        } else {
          deactivatedHelp.style.display = 'none';
        }
      }
    }

    function hideTargetPasswordSection() {
      const targetPasswordGroup = document.getElementById('target-password-group');
      targetPasswordGroup.style.display = 'none';
      wizardData.targetCredentialsVerified = false;
      wizardData.newPdsAccessToken = null;
      wizardData.newPdsRefreshToken = null;
      wizardData.accountExistsOnTarget = false;
      wizardData.accountDeactivatedOnTarget = false;
    }

    // PDS selection
    pdsSelect.addEventListener('change', function(e) {
      const selectedValue = e.target.value;
      const customGroup = document.getElementById('custom-pds-group');
      const inviteGroup = document.getElementById('invite-code-group');
      const status = document.getElementById('pds-status');

      wizardData.pdsVerified = false;
      wizardData.pdsVerifiedHost = null;
      hideTargetPasswordSection();

      if (selectedValue === 'custom') {
        customGroup.style.display = 'block';
        customPdsField.value = '';
        customPdsField.focus();
        inviteGroup.style.display = 'none';
        status.style.display = 'none';
      } else if (selectedValue) {
        customGroup.style.display = 'none';
        customPdsField.value = selectedValue;
        checkPdsRequirements(selectedValue, status, inviteGroup, function(success) {
          if (success) {
            // After PDS check succeeds, check if account already exists on target
            checkAccountExistsOnTarget(selectedValue, function(exists) {
              if (exists) {
                showTargetPasswordSection(selectedValue);
              }
            });
          }
        });
      } else {
        customGroup.style.display = 'none';
        inviteGroup.style.display = 'none';
        status.style.display = 'none';
      }
    });

    customPdsField.addEventListener('input', function() {
      if (pdsSelect.value === 'custom') {
        wizardData.pdsVerified = false;
        wizardData.pdsVerifiedHost = null;
      }
    });

    function checkPdsRequirements(pdsHost, statusElement, inviteGroup, callback) {
      showStatus(statusElement, 'Checking Server requirements...', 'info');

      fetch('/migrations/check_pds', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ pds_host: pdsHost })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showStatus(statusElement, data.error, 'error');
          inviteGroup.style.display = 'none';
          wizardData.pdsVerified = false;
          if (callback) callback(false);
          return;
        }

        showStatus(statusElement, 'Server verified!', 'success');

        wizardData.availableDomains = data.available_user_domains || [];
        wizardData.pdsVerified = true;
        wizardData.pdsVerifiedHost = pdsHost;

        if (data.invite_code_required) {
          inviteGroup.style.display = 'block';
          inviteCodeField.required = true;
          inviteCodeField.setAttribute('required', 'required');
        } else {
          inviteGroup.style.display = 'none';
          inviteCodeField.required = false;
          inviteCodeField.removeAttribute('required');
        }
        if (callback) callback(true);
      })
      .catch(error => {
        showStatus(statusElement, 'Failed to verify PDS. Please check the URL.', 'error');
        inviteGroup.style.display = 'none';
        wizardData.pdsVerified = false;
        if (callback) callback(false);
      });
    }

    // STEP 4: New Handle
    const newHandleInput = document.getElementById('new-handle-input');
    const newHandleSuffix = document.getElementById('new-handle-suffix');
    const preservationSection = document.getElementById('handle-preservation-section');
    const newHandleSection = document.getElementById('new-handle-section');
    const preserveCheckbox = document.getElementById('preserve-handle-checkbox');
    const customHandleDisplay = document.getElementById('custom-handle-display');

    function setupStep4() {
      // Existing account on target: show handle as read-only
      if (wizardData.accountExistsOnTarget && wizardData.existingHandleOnTarget) {
        preservationSection.style.display = 'none';
        newHandleSection.style.display = 'block';
        newHandleInput.value = wizardData.existingHandleOnTarget;
        newHandleSuffix.textContent = '';
        newHandleInput.readOnly = true;
        newHandleInput.style.paddingRight = '12px';
      } else if (wizardData.canPreserveHandle && wizardData.handleType === 'dns_verified') {
        // Custom domain: offer to keep it
        preservationSection.style.display = 'block';
        customHandleDisplay.textContent = '@' + wizardData.oldHandle;
        preserveCheckbox.checked = true;
        newHandleSection.style.display = 'none';
        newHandleInput.readOnly = false;
        newHandleInput.style.paddingRight = '200px';
      } else {
        // New account: editable handle, pre-filled with old handle prefix
        preservationSection.style.display = 'none';
        newHandleSection.style.display = 'block';
        newHandleInput.readOnly = false;
        newHandleInput.style.paddingRight = '200px';

        if (wizardData.availableDomains.length > 0) {
          const domain = wizardData.availableDomains[0];
          newHandleSuffix.textContent = domain.startsWith('.') ? domain : '.' + domain;
        } else {
          const pdsUrl = new URL(wizardData.pdsHost);
          newHandleSuffix.textContent = '.' + pdsUrl.hostname;
        }

        // Pre-fill with the username part of the old handle
        const oldHandleParts = (wizardData.oldHandle || '').split('.');
        newHandleInput.value = oldHandleParts.length > 0 ? oldHandleParts[0] : '';
        newHandleInput.focus();
      }
    }

    preserveCheckbox.addEventListener('change', function(e) {
      if (e.target.checked) {
        newHandleSection.style.display = 'none';
      } else {
        newHandleSection.style.display = 'block';

        if (wizardData.availableDomains.length > 0) {
          const domain = wizardData.availableDomains[0];
          newHandleSuffix.textContent = domain.startsWith('.') ? domain : '.' + domain;
        } else {
          const pdsUrl = new URL(wizardData.pdsHost);
          newHandleSuffix.textContent = '.' + pdsUrl.hostname;
        }
        newHandleInput.value = '';
        newHandleInput.focus();
      }
    });

    document.getElementById('step4-back').addEventListener('click', function(e) {
      e.preventDefault();
      showStep(3);
    });

    document.getElementById('step4-next').addEventListener('click', function(e) {
      e.preventDefault();

      const btn = e.target;
      const status = document.getElementById('step4-status');
      let fullHandle;

      // Existing account: use the handle as-is, skip all checks
      if (wizardData.accountExistsOnTarget && wizardData.existingHandleOnTarget) {
        fullHandle = wizardData.existingHandleOnTarget;
        document.getElementById('migration_new_handle').value = fullHandle;
        showStatus(status, 'Using your existing handle on the target server.', 'success');

        setTimeout(() => {
          showStep(5);
          setupStep5();
        }, 500);
        return;
      }

      if (wizardData.canPreserveHandle && preserveCheckbox.checked) {
        fullHandle = wizardData.oldHandle;
        document.getElementById('migration_new_handle').value = fullHandle;
        showStatus(status, 'Keeping your custom domain handle!', 'success');

        setTimeout(() => {
          showStep(5);
          setupStep5();
        }, 500);
        return;
      }

      const handleUsername = newHandleInput.value.trim();
      if (!handleUsername) {
        alert('Please enter a handle');
        return;
      }

      const suffix = newHandleSuffix.textContent;
      const userEndsWithDot = handleUsername.endsWith('.');
      const suffixStartsWithDot = suffix.startsWith('.');

      if (userEndsWithDot && suffixStartsWithDot) {
        fullHandle = handleUsername.slice(0, -1) + suffix;
      } else if (!userEndsWithDot && !suffixStartsWithDot) {
        fullHandle = handleUsername + '.' + suffix;
      } else {
        fullHandle = handleUsername + suffix;
      }

      btn.disabled = true;
      btn.textContent = 'Checking availability...';
      showStatus(status, 'Checking if handle is available...', 'info');

      fetch('/migrations/check_handle', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          handle: fullHandle,
          pds_host: wizardData.pdsHost,
          did: wizardData.did
        })
      })
      .then(response => response.json())
      .then(data => {
        btn.disabled = false;
        btn.textContent = 'Continue';

        if (data.error) {
          showStatus(status, data.error, 'error');
          return;
        }

        if (!data.available) {
          showStatus(status, 'This handle is already taken. Please choose another.', 'error');
          return;
        }

        // Skip DID check if account was already verified in Step 3 (migration_in)
        if (wizardData.accountExistsOnTarget && wizardData.targetCredentialsVerified) {
          showStatus(status, 'All checks passed!', 'success');
          document.getElementById('migration_new_handle').value = fullHandle;

          setTimeout(() => {
            showStep(5);
            setupStep5();
          }, 500);
          return;
        }

        showStatus(status, 'Handle available, checking for existing accounts...', 'info');
        btn.disabled = true;
        btn.textContent = 'Checking for existing accounts...';

        fetch('/migrations/check_did_on_pds', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({
            did: wizardData.did,
            pds_host: wizardData.pdsHost
          })
        })
        .then(response => response.json())
        .then(didData => {
          btn.disabled = false;
          btn.textContent = 'Continue';

          if (didData.error) {
            showStatus(status, didData.error, 'error');
            return;
          }

          if (didData.exists) {
            const supportEmail = didData.support_email || 'support@example.com';
            const errorMessage = `
              <div class="text-start lh-lg">
                <strong>Account Already Exists on Target Server</strong><br><br>
                <strong>What happened:</strong><br>
                An account with your DID already exists on the target Server (${wizardData.pdsHost}).
                This may be from a previous migration attempt.<br><br>

                <strong>What to do:</strong><br>
                Go back to the previous step and enter your password for the existing account. If you don't know the password:
                <ul class="ms-3">
                  <li>Try resetting your password: <a href="${wizardData.pdsHost.replace(/\/$/, '')}/.well-known/change-password" target="_blank" rel="noopener">${wizardData.pdsHost.replace(/\/$/, '')}/.well-known/change-password</a></li>
                  <li>Contact the Server provider at <strong>${supportEmail}</strong> to remove the orphaned account</li>
                  <li>Include your DID: <code>${wizardData.did}</code></li>
                </ul>
              </div>
            `;

            status.className = 'lookup-status lookup-error mt-3';
            status.innerHTML = errorMessage;
            status.style.display = 'block';
            return;
          }

          showStatus(status, 'All checks passed!', 'success');
          document.getElementById('migration_new_handle').value = fullHandle;

          setTimeout(() => {
            showStep(5);
            setupStep5();
          }, 500);
        })
        .catch(didError => {
          btn.disabled = false;
          btn.textContent = 'Continue';
          showStatus(status, 'Failed to check for existing accounts: ' + didError.message, 'error');
        });
      })
      .catch(error => {
        btn.disabled = false;
        btn.textContent = 'Continue';
        showStatus(status, 'Failed to check availability. Please try again.', 'error');
      });
    });

    // STEP 5: Summary
    function setupStep5() {
      document.getElementById('summary-handle').textContent = handleField.value;
      document.getElementById('summary-email').textContent = emailField.value;
      document.getElementById('summary-pds').textContent = wizardData.pdsHost;
      document.getElementById('summary-new-handle').textContent = document.getElementById('migration_new_handle').value;
      document.getElementById('summary-email-reminder').textContent = emailField.value;

      if (inviteCodeField.value.trim()) {
        document.getElementById('summary-invite-row').style.display = 'table-row';
        document.getElementById('summary-invite').textContent = inviteCodeField.value;
      } else {
        document.getElementById('summary-invite-row').style.display = 'none';
      }
    }

    document.getElementById('step5-back').addEventListener('click', function(e) {
      e.preventDefault();
      showStep(4);
    });

    // Handle form submission
    form.addEventListener('submit', function(event) {
      event.preventDefault();

      const currentStep = document.querySelector('.wizard-step.active');
      if (!currentStep || currentStep.id !== 'step-5') {
        return;
      }

      const acknowledgeCheckbox = document.getElementById('acknowledge-no-usage');
      if (!acknowledgeCheckbox.checked) {
        alert('Please confirm that you understand you must not use your account during migration.');
        acknowledgeCheckbox.focus();
        return;
      }

      document.getElementById('migration_old_access_token').value = wizardData.accessToken || '';
      document.getElementById('migration_old_refresh_token').value = wizardData.refreshToken || '';
      document.getElementById('migration_new_access_token').value = wizardData.newPdsAccessToken || '';
      document.getElementById('migration_new_refresh_token').value = wizardData.newPdsRefreshToken || '';

      passwordField.value = '';
      const targetPwdField = document.getElementById('target-pds-password');
      if (targetPwdField) targetPwdField.value = '';

      form.submit();
    });
  });
</script>
<% end %>

<div class="new-migration-container">
  <div class="new-migration-content">
    <div class="new-migration-header">
      <h1><%= EuroskyConfig::SITE_NAME %></h1>
      <p><%= EuroskyConfig::SITE_SUBTITLE %></p>
    </div>

    <% if @migration&.errors&.any? %>
      <div class="alert alert-danger" role="alert">
        <h6 class="alert-heading fw-bold">Please correct the following errors:</h6>
        <ul class="mb-0">
          <% @migration.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= form_with model: @migration, url: migrations_path, local: true, html: { novalidate: true } do |f| %>
      <!-- Hidden fields for authentication tokens -->
      <%= hidden_field_tag 'migration[old_access_token]', '', id: 'migration_old_access_token' %>
      <%= hidden_field_tag 'migration[old_refresh_token]', '', id: 'migration_old_refresh_token' %>

      <!-- Progress Indicator -->
      <div class="wizard-progress mb-4">
        <div id="progress-1" class="wizard-progress-step">
          <div class="wizard-progress-circle">1</div>
          <div class="wizard-progress-label">Account</div>
        </div>
        <div id="progress-2" class="wizard-progress-step">
          <div class="wizard-progress-circle">2</div>
          <div class="wizard-progress-label">Email</div>
        </div>
        <div id="progress-3" class="wizard-progress-step">
          <div class="wizard-progress-circle">3</div>
          <div class="wizard-progress-label">Destination</div>
        </div>
        <div id="progress-4" class="wizard-progress-step">
          <div class="wizard-progress-circle">4</div>
          <div class="wizard-progress-label">Handle</div>
        </div>
        <div id="progress-5" class="wizard-progress-step">
          <div class="wizard-progress-circle">5</div>
          <div class="wizard-progress-label">Review</div>
        </div>
      </div>

      <!-- STEP 1: Handle & Password -->
      <div id="step-1" class="wizard-step">
        <h2 class="mb-3">Step 1: Account Credentials</h2>

        <div class="mb-3">
          <%= f.label :old_handle, "Your Handle", class: "form-label" %>
          <%= f.text_field :old_handle, id: "migration_old_handle", placeholder: "yourhandle.bsky.social", autocomplete: "username", class: "form-control" %>
          <div class="form-text">Enter your current AT Protocol handle</div>
        </div>

        <div class="mb-3">
          <%= f.label :password, "Account Password", class: "form-label" %>
          <%= f.password_field :password, id: "migration_password", autocomplete: "current-password", class: "form-control" %>
          <div class="form-text">Your current account password</div>
        </div>

        <div id="step1-status" class="lookup-status"></div>

        <!-- Two-Factor Authentication -->
        <div id="two-factor-group" class="alert alert-warning border-start border-warning border-4 rounded-1 py-2 px-3 mb-3" style="display: none;">
          <div class="fw-semibold small mb-1" style="color: #92400e;">Two-Factor Authentication</div>
          <p class="small mb-2" style="color: #78350f;">
            A sign-in code has been sent to your email. Enter it below.
          </p>
          <input type="text" id="two_factor_code" class="form-control form-control-lg text-center font-monospace" placeholder="Enter your sign-in code" autocomplete="one-time-code" inputmode="numeric">
        </div>

        <div class="d-grid mt-4">
          <button type="button" id="step1-next" class="btn btn-lg btn-gradient">Continue</button>
        </div>
      </div>

      <!-- STEP 2: Email -->
      <div id="step-2" class="wizard-step">
        <h2 class="mb-3">Step 2: Email Address</h2>

        <div class="mb-3">
          <%= f.label :email, "Email Address", class: "form-label" %>
          <%= f.email_field :email, id: "migration_email", placeholder: "you@example.com", autocomplete: "email", class: "form-control" %>
          <div class="form-text">We'll send migration status updates to this email</div>
        </div>

        <div class="alert alert-warning border-start border-warning border-4 rounded-1 py-2 px-3 mb-3 small">
          <div class="form-check mb-0">
            <input type="checkbox" id="confirm-email-access" class="form-check-input">
            <label class="form-check-label" for="confirm-email-access" style="color: #78350f;">
              I have access to this email address and can retrieve a confirmation code sent to it.
            </label>
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="button" id="step2-back" class="btn btn-secondary">Back</button>
          <button type="button" id="step2-next" class="btn btn-lg btn-gradient flex-grow-1">Continue</button>
        </div>
      </div>

      <!-- STEP 3: Destination PDS -->
      <div id="step-3" class="wizard-step">
        <h2 class="mb-3">Step 3: Destination Sever</h2>

        <div class="mb-3">
          <label for="pds-select" class="form-label">Destination Server</label>
          <select id="pds-select" class="form-select form-select-lg">
            <option value="">Select a Server...</option>
            <option value="https://eurosky.social">Eurosky (eurosky.social)</option>
            <option value="https://blacksky.app">Blacksky (blacksky.app)</option>
            <option value="https://myatproto.social">myatproto (myatproto.social)</option>
            <option value="https://bsky.social">Bluesky (bsky.social)</option>
            <option value="custom">Custom Server...</option>
          </select>
          <div class="form-text">Choose where you want to migrate your account</div>
        </div>

        <div id="custom-pds-group" class="mb-3" style="display: none;">
          <%= f.label :new_pds_host, "Custom Server URL", class: "form-label" %>
          <%= f.text_field :new_pds_host, id: "migration_new_pds_host", placeholder: "https://pds.example.com", autocomplete: "url", class: "form-control" %>
          <div class="form-text">Enter the full URL of your custom Server</div>
        </div>

        <div id="pds-status" class="lookup-status"></div>

        <div id="invite-code-group" class="mb-3" style="display: none;">
          <%= f.label :invite_code, "Invite Code", class: "form-label" %>
          <%= f.text_field :invite_code, id: "migration_invite_code", placeholder: "Enter your invite code", autocomplete: "off", class: "form-control" %>
          <div class="form-text">This Server requires an invite code</div>
        </div>

        <!-- Target PDS password (for existing account on target server) -->
        <div id="target-password-group" class="alert alert-info border-start border-info border-4 rounded-1 py-2 px-3 mt-3 mb-3" style="display: none;">
          <div class="fw-semibold small mb-1" style="color: #0c4a6e;">Existing Account Found</div>
          <p class="small mb-2" style="color: #164e63;">
            Your account already exists on this server. Please verify your password to continue with the migration.
          </p>
          <div class="mb-2">
            <label for="target-pds-password" class="form-label small">Your password on the target server</label>
            <input type="password" id="target-pds-password" class="form-control" placeholder="Enter your password for the existing account" autocomplete="current-password">
          </div>
          <div id="target-2fa-group" class="mt-2" style="display: none;">
            <label for="target-2fa-code" class="form-label small">Sign-in Code (2FA)</label>
            <input type="text" id="target-2fa-code" class="form-control form-control-lg text-center font-monospace" placeholder="Enter your sign-in code" autocomplete="one-time-code" inputmode="numeric">
            <div class="form-text">Check your email for the two-factor authentication code</div>
          </div>
          <div id="target-deactivated-help" class="mt-2 small" style="display: none; color: #78350f; background: #fef3c7; padding: 10px; border-radius: 4px;">
            <strong>This account appears to be deactivated</strong> (possibly from a previous migration attempt).<br>
            If you don't remember your password, you can try:
            <ul class="mb-1 mt-1">
              <li>Reset your password: <a id="target-deactivated-pwd-link" href="#" target="_blank" rel="noopener"></a></li>
              <li>Contact the PDS admin at <a id="target-deactivated-support-email" href="#"></a> to remove the orphaned account. Include your DID: <code id="target-deactivated-did"></code></li>
            </ul>
          </div>
          <div id="target-password-status" class="lookup-status"></div>
        </div>

        <!-- Hidden fields for target PDS tokens -->
        <%= hidden_field_tag 'migration[new_access_token]', '', id: 'migration_new_access_token' %>
        <%= hidden_field_tag 'migration[new_refresh_token]', '', id: 'migration_new_refresh_token' %>

        <div class="d-flex gap-2 mt-4">
          <button type="button" id="step3-back" class="btn btn-secondary">Back</button>
          <button type="button" id="step3-next" class="btn btn-lg btn-gradient flex-grow-1">Continue</button>
        </div>
      </div>

      <!-- STEP 4: New Handle -->
      <div id="step-4" class="wizard-step">
        <h2 class="mb-3">Step 4: New Handle</h2>

        <!-- Custom Domain Handle Preservation Option -->
        <div id="handle-preservation-section" class="alert alert-info border-start border-info border-4 rounded-1 py-2 px-3 mb-3 small" style="display: none;">
          <div class="fw-semibold mb-1" style="color: #075985;">Custom Domain Detected</div>
          <p class="mb-2" style="color: #075985;">
            Your handle <strong id="custom-handle-display"></strong> is a custom domain. You can keep using it on the new server.
          </p>
          <div class="form-check mb-0">
            <input type="checkbox" id="preserve-handle-checkbox" checked class="form-check-input">
            <label class="form-check-label fw-semibold" for="preserve-handle-checkbox">Keep my current handle</label>
          </div>
        </div>

        <!-- Regular Handle Input -->
        <div id="new-handle-section" class="mb-3">
          <label for="new-handle-input" class="form-label">Your New Handle</label>
          <div class="position-relative">
            <input type="text" id="new-handle-input" class="form-control" placeholder="username" style="padding-right: 200px;">
            <span id="new-handle-suffix" class="handle-suffix"></span>
          </div>
          <div class="form-text">Choose your new handle (can be your old) on the destination Server</div>
          <%= f.hidden_field :new_handle, id: "migration_new_handle" %>
        </div>

        <div id="step4-status" class="lookup-status"></div>

        <div class="d-flex gap-2 mt-4">
          <button type="button" id="step4-back" class="btn btn-secondary">Back</button>
          <button type="button" id="step4-next" class="btn btn-lg btn-gradient flex-grow-1">Continue</button>
        </div>
      </div>

      <!-- STEP 5: Summary & Confirm -->
      <div id="step-5" class="wizard-step">
        <h2 class="mb-3">Step 5: Review & Confirm</h2>

        <table class="table mb-4">
          <tr>
            <td class="fw-semibold">Current Handle:</td>
            <td id="summary-handle"></td>
          </tr>
          <tr>
            <td class="fw-semibold">Email:</td>
            <td id="summary-email"></td>
          </tr>
          <tr>
            <td class="fw-semibold">Destination Server:</td>
            <td id="summary-pds"></td>
          </tr>
          <tr>
            <td class="fw-semibold">New Handle:</td>
            <td class="fw-bold text-primary" id="summary-new-handle"></td>
          </tr>
          <tr id="summary-invite-row" style="display: none;">
            <td class="fw-semibold">Invite Code:</td>
            <td id="summary-invite"></td>
          </tr>
        </table>

        <div class="alert alert-success border-start border-success border-4 rounded-1 py-2 px-3 mb-3 small">
          <div class="form-check mb-0">
            <%= f.check_box :create_backup_bundle, id: "migration_create_backup_bundle", checked: true, class: "form-check-input" %>
            <label class="form-check-label fw-semibold" for="migration_create_backup_bundle">
              Create a backup before migration
            </label>
            <div class="text-body-secondary mt-1">
              Downloads a complete copy of your account data. Available for 24 hours.
            </div>
          </div>
        </div>

        <div class="alert alert-info border-start border-primary border-4 rounded-1 py-2 px-3 mb-3 small">
          When you click <strong>Continue</strong>, we'll send a confirmation email to <strong id="summary-email-reminder"></strong>.
          The migration will only start once you confirm via that email.
        </div>

        <div class="alert alert-warning border-start border-warning border-4 rounded-1 py-2 px-3 mb-3 small">
          <div class="fw-semibold mb-1" style="color: #92400e;">Do not use your account during migration</div>
          <p class="mb-2" style="color: #78350f;">
            Once the migration starts, close all apps and browser tabs with your account.
            Any posts, likes, or follows made during migration will not be transferred.
            You'll receive an email when it's complete (~20-30 minutes).
          </p>
          <div class="form-check mb-0">
            <input type="checkbox" id="acknowledge-no-usage" class="form-check-input" required>
            <label class="form-check-label fw-semibold" for="acknowledge-no-usage" style="color: #92400e;">
              I understand I should not use my account during migration
            </label>
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="button" id="step5-back" class="btn btn-secondary">Back</button>
          <%= f.submit "Continue", class: "btn btn-lg btn-gradient flex-grow-1", id: "start-migration-btn" %>
        </div>
      </div>

    <% end %>

    <!-- Legal Links -->
    <% if EuroskyConfig::PRIVACY_POLICY_URL.present? || EuroskyConfig::TERMS_OF_SERVICE_URL.present? %>
      <div class="text-center mt-3 small text-muted">
        <% if EuroskyConfig::PRIVACY_POLICY_URL.present? %>
          <a href="<%= EuroskyConfig::PRIVACY_POLICY_URL %>" target="_blank" rel="noopener" class="text-muted">Privacy Policy</a>
        <% end %>
        <% if EuroskyConfig::PRIVACY_POLICY_URL.present? && EuroskyConfig::TERMS_OF_SERVICE_URL.present? %>
          <span class="mx-1">Â·</span>
        <% end %>
        <% if EuroskyConfig::TERMS_OF_SERVICE_URL.present? %>
          <a href="<%= EuroskyConfig::TERMS_OF_SERVICE_URL %>" target="_blank" rel="noopener" class="text-muted">Terms of Service</a>
        <% end %>
      </div>
    <% end %>

    <!-- Image Attribution -->
    <div class="text-center mt-3 small text-muted">
      Background photo: <a href="https://commons.wikimedia.org/wiki/File:GMC_U-Haul_truck_front_1.JPG" target="_blank" rel="noopener" class="text-muted">GMC U-Haul truck</a> by <a href="https://commons.wikimedia.org/wiki/User:BrokenSphere" target="_blank" rel="noopener" class="text-muted">BrokenSphere</a>, <a href="https://creativecommons.org/licenses/by/3.0" target="_blank" rel="noopener" class="text-muted">CC BY 3.0</a>
    </div>
  </div>
</div>
