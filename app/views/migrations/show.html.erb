<% content_for :title do %><%= t('migrations.show.page_title', token: @migration.token) %> - <%= EuroskyConfig::SITE_NAME %><% end %>

<% content_for :head do %>
  <style>
    /* Background + centering (matches new.html.erb) */
    body {
      margin: 0;
      padding: 0;
      <% if EuroskyConfig::BACKGROUND_IMAGE_URL.present? %>
      background: url('<%= EuroskyConfig::BACKGROUND_IMAGE_URL %>') no-repeat center center fixed;
      background-size: cover;
      <% else %>
      background: var(--gradient);
      <% end %>
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    <% if EuroskyConfig::BACKGROUND_IMAGE_URL.present? %>
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 0;
    }
    <% end %>

    /* Page-specific layout styles for show.html.erb */
    .page-layout {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: center;
      max-width: 1020px;
      margin: 0 auto;
      padding: 40px 16px;
    }

    .page-layout.has-sidebar {
      display: grid;
      grid-template-columns: minmax(0, 700px) 280px;
      gap: 24px;
      align-items: start;
      justify-content: center;
    }

    .page-layout > .container {
      max-width: 700px;
    }

    .has-sidebar .container {
      max-width: none;
    }

    .backup-sidebar {
      position: sticky;
      top: 20px;
    }

    .backup-sidebar-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      border-left: 4px solid #10b981;
      margin-bottom: 16px;
    }

    .backup-sidebar-card.backup-urgent {
      border-left-color: #3b82f6;
    }

    .backup-sidebar-header {
      background: #d1fae5;
      padding: 16px;
      font-weight: 700;
      font-size: 15px;
      color: #065f46;
    }

    .backup-urgent .backup-sidebar-header {
      background: #dbeafe;
      color: #1e40af;
    }

    .backup-sidebar-body {
      padding: 16px;
    }

    .backup-sidebar-body p {
      font-size: 13px;
      color: #374151;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .backup-sidebar-body .backup-meta {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .backup-sidebar-body .backup-meta strong {
      color: #374151;
    }

    .backup-sidebar-body .backup-download-btn {
      display: block;
      text-align: center;
      padding: 12px 16px;
      background: var(--gradient);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .backup-sidebar-body .backup-download-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .bookmark-notice code {
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: "SF Mono", Monaco, "Courier New", monospace;
      font-size: 13px;
      word-break: break-all;
    }

    .progress-bar-container {
      background: #e5e7eb;
      height: 30px;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      background: var(--gradient);
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      transition: width 0.3s ease;
    }

    .status-completed { color: #10b981; }
    .status-failed { color: #dc2626; }
    .status-in-progress { color: #3b82f6; }

    /* Header-specific overrides: white text on gradient */
    .header-eurosky .status-completed,
    .header-eurosky .status-failed,
    .header-eurosky .status-in-progress {
      color: white !important;
    }

    .header-eurosky .progress-bar-container {
      background: rgba(255, 255, 255, 0.2);
      height: 24px;
      border-radius: 12px;
    }

    .header-eurosky .progress-bar-fill {
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-color);
      font-size: 13px;
      border-radius: 12px;
    }

    .header-eurosky #retry-info {
      color: rgba(255, 255, 200, 0.9) !important;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
    }

    @media (max-width: 1060px) {
      .page-layout.has-sidebar {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .has-sidebar .container {
        display: block;
        max-width: 700px;
      }

      .backup-sidebar {
        position: static;
        width: 100%;
        max-width: 700px;
        margin-bottom: 20px;
        order: -1;
      }
    }

    @media (max-width: 640px) {
      .page-layout {
        padding: 20px 12px;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
<% end %>

<% show_sidebar = @migration.backup_available? || (@migration.rotation_key.present? && @migration.email_verified?) || (@migration.cancellable? && @migration.email_verified?) %>
<div class="page-layout<%= ' has-sidebar' if show_sidebar %>">
  <div class="container">
    <div class="card-eurosky">
    <div class="header-eurosky p-4">
      <% if EuroskyConfig::LOGO_URL.present? %>
        <img src="<%= EuroskyConfig::LOGO_URL %>" alt="<%= EuroskyConfig::SITE_NAME %>" class="header-logo">
      <% end %>

      <% if @migration.email_verified? %>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h1 class="fs-3 mb-0"><%= t('migrations.show.migration_status') %></h1>
          <div class="token-badge" style="font-size: 16px; padding: 4px 12px;"><%= @migration.token %></div>
        </div>

        <div class="d-flex align-items-baseline justify-content-between mb-2">
          <div>
            <span class="small" style="opacity: 0.7;"><%= t('migrations.show.status_label') %></span>
            <span id="status-value" class="fw-semibold status-<%= @migration.completed? ? 'completed' : @migration.failed? ? 'failed' : 'in-progress' %>" data-status="<%= @migration.status %>">
              <span id="status-text"><%= @migration.status.humanize %></span>
            </span>
          </div>
          <div id="retry-info" class="small" style="<%= 'display:none;' unless @migration.job_retrying? && @migration.current_job_step %>">
            <% if @migration.job_retrying? && @migration.current_job_step %>
              <%= t('migrations.show.retry_info', attempt: @migration.current_job_attempt, max: @migration.current_job_max_attempts, step: @migration.current_job_step.gsub('Job', '').humanize) %>
            <% end %>
          </div>
        </div>

        <div id="progress-bar-container" class="progress-bar-container" role="progressbar" aria-valuenow="<%= @migration.progress_percentage %>" aria-valuemin="0" aria-valuemax="100">
          <div id="progress-bar" class="progress-bar-fill" style="width: <%= @migration.progress_percentage %>%">
            <%= @migration.progress_percentage %>%
          </div>
        </div>
      <% else %>
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="fs-3 mb-0"><%= t('migrations.show.verify_email') %></h1>
          <div class="token-badge" style="font-size: 16px; padding: 4px 12px;"><%= @migration.token %></div>
        </div>
      <% end %>
    </div>

    <div class="p-4">
      <% if flash[:notice] %>
        <div class="alert alert-success border-start border-success border-4 rounded-1 small" role="alert">
          <%= flash[:notice] %>
        </div>
      <% end %>
      <% if flash[:alert] %>
        <div class="alert alert-danger border-start border-danger border-4 rounded-1 small" role="alert">
          <%= flash[:alert] %>
        </div>
      <% end %>

      <% if !@migration.email_verified? %>
        <%# Awaiting email confirmation ‚Äî show code entry form %>
        <div class="text-center pt-2 pb-3">
          <h2 class="fs-4 mb-2 text-dark"><%= t('migrations.show.enter_verification') %></h2>
          <p class="small text-body-secondary mx-auto mb-0" style="max-width: 480px;">
            <%= t('migrations.show.verification_sent', email: @migration.email).html_safe %>
          </p>
        </div>

        <%= form_with url: verify_email_path(token: @migration.token), method: :post, local: true do |f| %>
          <div class="form-group">
            <%= label_tag :verification_code, t('migrations.show.verification_label') %>
            <%= text_field_tag :verification_code, nil, required: true, placeholder: t('migrations.show.verification_placeholder'), autocomplete: "off", maxlength: 7, class: "form-control font-monospace fs-3 text-center text-uppercase", style: "letter-spacing: 4px;" %>
          </div>
          <%= submit_tag t('migrations.show.verify_button'), class: "btn btn-lg btn-gradient w-100 mt-3" %>
        <% end %>

        <div class="alert alert-warning border-start border-warning border-4 rounded-1 py-2 px-3 mt-4 mb-3 small">
          <div class="fw-semibold mb-1" style="color: #92400e;"><%= t('migrations.show.didnt_receive') %></div>
          <ul class="mb-0 ps-3 lh-lg" style="color: #78350f;">
            <li><%= t('migrations.show.check_spam') %></li>
            <li><%= t('migrations.show.check_email_correct', email: @migration.email).html_safe %></li>
            <li><%= t('migrations.show.email_delay') %></li>
          </ul>
        </div>

      <% else %>

        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>
        <%# Status + progress bar are now in the header above       %>
        <%# Body contains: notices, metrics, actions, help          %>
        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>

        <div id="queued-notice" class="alert alert-primary border-start border-primary border-4 rounded-1 py-2 px-3 mb-3 small" style="<%= 'display:none;' unless @migration.progress_data&.dig('queued') %>">
          <div class="fw-semibold text-primary mb-1"><%= t('migrations.show.in_queue') %></div>
          <p id="queued-reason" class="text-primary small mb-0">
            <%= @migration.progress_data&.dig('queued_reason') || t('migrations.show.queue_default') %>
          </p>
          <p class="text-primary small mt-1 mb-0" style="opacity: 0.8;"><%= t('migrations.show.queue_auto_start') %></p>
        </div>

        <% if @migration.progress_data&.dig('legacy_blob_conversion_started_at') && !@migration.progress_data&.dig('legacy_blob_conversion_completed_at') %>
          <div class="alert alert-warning border-start border-warning border-4 rounded-1 py-2 px-3 mb-3 small">
            üîÑ <strong><%= t('migrations.show.converting_blobs') %></strong> ‚Äî <%= t('migrations.show.converting_blobs_detail') %>
          </div>
        <% elsif @migration.progress_data&.dig('legacy_blobs_converted') == true %>
          <div class="alert alert-success border-start border-success border-4 rounded-1 py-2 px-3 mb-3 small">
            ‚úÖ <%= t('migrations.show.blobs_converted') %>
          </div>
        <% end %>

        <% if @migration.pending_blobs? %>
          <% blobs_completed = @migration.progress_data['blobs_completed'].to_i %>
          <% blobs_total = @migration.progress_data['blobs_total'].to_i %>
          <% bytes_transferred = @migration.progress_data['bytes_transferred'].to_i %>
          <% if blobs_total > 0 %>
            <div id="blob-progress-section" class="metrics-grid mb-3">
              <div class="card bg-body-tertiary border">
                <div class="card-body p-3">
                  <div class="small text-body-secondary mb-1"><%= t('migrations.show.blobs_uploaded') %></div>
                  <div class="metric-value">
                    <span id="blobs-completed"><%= blobs_completed %></span>
                    <span class="small fw-normal text-body-secondary">/ <span id="blobs-total"><%= blobs_total %></span> <%= t('migrations.show.files') %></span>
                  </div>
                </div>
              </div>
              <div class="card bg-body-tertiary border">
                <div class="card-body p-3">
                  <div class="small text-body-secondary mb-1"><%= t('migrations.show.data_transferred') %></div>
                  <div class="metric-value">
                    <span id="bytes-transferred"><%= number_to_human_size(bytes_transferred) %></span>
                  </div>
                </div>
              </div>
              <% if @migration.progress_data['failed_blobs'].present? %>
                <div class="card bg-body-tertiary border">
                  <div class="card-body p-3">
                    <div class="small text-body-secondary mb-1"><%= t('migrations.show.failed') %></div>
                    <div class="metric-value text-danger">
                      <span id="blobs-failed"><%= @migration.progress_data['failed_blobs'].length %></span>
                      <span class="small fw-normal text-body-secondary"><%= t('migrations.show.files') %></span>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% elsif @migration.progress_data['blob_count'].to_i > 0 %>
            <div id="blob-progress-section" class="alert alert-info border-start border-primary border-4 rounded-1 py-2 px-3 mb-3 small">
              <%= t('migrations.show.preparing_blobs', count: @migration.progress_data['blob_count']).html_safe %>
            </div>
          <% end %>
        <% end %>

        <% if @migration.pending_download? || @migration.pending_backup? %>
          <div class="alert alert-info border-start border-primary border-4 rounded-1 py-2 px-3 mb-3 small">
            <% if @migration.pending_download? %>
              üì• <strong><%= t('migrations.show.downloading_account') %></strong> &mdash; <%= t('migrations.show.downloading_detail') %>
            <% else %>
              üì¶ <strong><%= t('migrations.show.creating_backup') %></strong> &mdash; <%= t('migrations.show.creating_backup_detail') %>
            <% end %>
            <% if @migration.progress_data&.dig('download_progress') %>
              <% progress = @migration.progress_data['download_progress'] %>
              <br><%= t('migrations.show.downloaded_count', downloaded: progress['downloaded'], total: progress['total']) %>
              <% if progress['bytes'] %>(<%= number_to_human_size(progress['bytes']) %>)<% end %>
            <% end %>
          </div>
        <% end %>

        <% if @migration.backup_bundle_path.present? && @migration.backup_expired? %>
          <div class="alert alert-danger border-start border-danger border-4 rounded-1 py-2 px-3 mb-3 small">
            ‚ö†Ô∏è <strong><%= t('migrations.show.backup_expired') %></strong> ‚Äî <%= t('migrations.show.backup_expired_detail') %>
          </div>
        <% end %>

        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>
        <%# ZONE 2: PRIMARY CONTENT ‚Äî state-specific hero content   %>
        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>

        <% if @migration.pending_plc? %>
          <hr class="section-divider">
          <% plc_token_submitted = @migration.encrypted_plc_token.present? && !@migration.plc_token_expired? %>

          <% if plc_token_submitted %>
            <div class="text-center py-4">
              <div class="fs-1 mb-2"><span class="spin">‚öô</span></div>
              <h3 class="fs-5 mb-2 text-dark"><%= t('migrations.show.updating_identity') %></h3>
              <p class="text-body-secondary lh-lg mx-auto mb-0" style="max-width: 500px;">
                <%= t('migrations.show.plc_accepted', pds: @migration.new_pds_host).html_safe %>
              </p>
              <p class="text-primary small mt-3 mb-0">
                <%= t('migrations.show.page_auto_update') %>
              </p>
            </div>

          <% else %>
            <div class="text-center mb-3">
              <h3 class="fs-5 mb-1 text-dark"><%= t('migrations.show.enter_confirmation') %></h3>
              <p class="text-body-secondary small mb-0">
                <%= t('migrations.show.confirmation_hint', pds: @migration.old_pds_host).html_safe %>
              </p>
            </div>

            <%= form_with url: submit_plc_token_by_token_path(@migration.token), method: :post, local: true do |f| %>
              <div class="form-group">
                <%= label_tag :plc_token, t('migrations.show.confirmation_label') %>
                <%= text_field_tag :plc_token, nil, required: true, placeholder: t('migrations.show.confirmation_placeholder'), autocomplete: "off", class: "form-control font-monospace fs-4 text-center py-3", style: "letter-spacing: 3px;" %>
              </div>
              <%= submit_tag t('migrations.show.complete_migration'), class: "btn btn-lg btn-gradient w-100 mt-3", onclick: "return confirm('#{j t('migrations.show.complete_confirm')}');" %>
            <% end %>

           
          <% end %>

        <% elsif @migration.completed? %>
          <hr class="section-divider">

          <div class="alert alert-success" role="alert">
            <h3 class="fs-4 mb-3">‚úÖ <%= t('migrations.show.completed_title') %></h3>
            <p class="fs-6">
              <% if @migration.returning_to_existing_pds? %>
                <%= t('migrations.show.completed_migrated_back', pds: @migration.new_pds_host, handle: @migration.new_handle).html_safe %>
              <% else %>
                <%= t('migrations.show.completed_migrated_to', pds: @migration.new_pds_host, handle: @migration.new_handle).html_safe %>
              <% end %>
            </p>

            <div class="bg-primary-subtle border-start border-primary border-4 p-3 rounded-2 my-3">
              <p class="small mb-0" style="color: #1e40af;">
                <%= t('migrations.show.email_sent_html', email: @migration.email).html_safe %>
              </p>
            </div>

            <% if @migration.rotation_key.present? %>
              <div class="bg-warning-subtle border-start border-warning border-4 p-3 rounded-2 my-4">
                <h4 class="fs-5 mb-2" style="color: #92400e;">‚ö†Ô∏è <%= t('migrations.show.save_rotation_key') %></h4>
                <p class="small mb-3" style="color: #92400e;">
                  <strong><%= t('migrations.show.page_auto_delete') %></strong><br>
                  <%= t('migrations.show.rotation_key_needed') %>
                </p>
                <div class="bg-white p-3 rounded-2 my-3 font-monospace small" style="overflow-wrap: break-word; word-break: break-all;">
                  <%= @migration.rotation_key %>
                </div>
                <button onclick="navigator.clipboard.writeText('<%= @migration.rotation_key %>'); this.textContent='‚úÖ Copied!'; setTimeout(() => this.textContent='üìã <%= j t('migrations.show.copy_rotation_key') %>', 2000)"
                        class="btn btn-warning text-white fw-semibold mb-2">
                  üìã <%= t('migrations.show.copy_rotation_key') %>
                </button>
                <p class="small mt-3 mb-0" style="color: #92400e;">
                  ‚úâÔ∏è <%= t('migrations.show.key_emailed', email: @migration.email).html_safe %>
                </p>
              </div>
            <% end %>

            <div class="bg-info-subtle border-start border-primary border-4 p-3 rounded-2 my-3">
              <h4 class="fw-semibold mb-2" style="color: #3730a3;">üîí <%= t('migrations.show.privacy_notice') %></h4>
              <p class="small mb-2" style="color: #3730a3;">
                <%= t('migrations.show.privacy_detail').html_safe %>
              </p>
              <p class="small mb-0" style="color: #3730a3;">
                <%= t('migrations.show.privacy_delete_now') %>
              </p>
            </div>

            <div class="border-top pt-3 mt-3">
              <form action="<%= confirm_delete_by_token_path(@migration.token) %>" method="post"
                    onsubmit="return confirm('<%= j t('migrations.show.delete_confirm') %>');">
                <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                <button type="submit" class="btn btn-outline-danger w-100">
                  <%= t('migrations.show.delete_button') %>
                </button>
              </form>
            </div>

            <p class="mt-3 small text-success">
              <%= @migration.returning_to_existing_pds? ? t('migrations.show.welcome_back') : t('migrations.show.welcome_new') %>
            </p>
          </div>

        <% elsif @migration.failed? %>
          <hr class="section-divider">
          <%= render 'migrations/error_details', migration: @migration %>
        <% end %>

        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>
        <%# ZONE 3: SECONDARY / HELP ‚Äî collapsed detail sections    %>
        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>

        <% show_zone3 = false %>
        <% show_zone3 = true if @migration.rotation_key.present? && !@migration.completed? && !@migration.pending_download? && !@migration.pending_backup? %>
        <% show_zone3 = true if @migration.pending_plc? && !(@migration.encrypted_plc_token.present? && !@migration.plc_token_expired?) %>

        <% if show_zone3 %>
          <hr class="section-divider">

          <%# Rotation key (collapsible, open by default) %>
          <% if @migration.rotation_key.present? && !@migration.completed? && !@migration.pending_download? && !@migration.pending_backup? %>
            <details class="mb-3">
              <summary class="fw-semibold small" style="cursor: pointer; color: #92400e;">
                üîë <%= t('migrations.show.recovery_key_title') %>
              </summary>
              <div class="bg-warning-subtle border-start border-warning border-4 p-3 rounded-2 mt-2">
                <p class="small mb-2" style="color: #92400e;">
                  <strong><%= t('migrations.show.recovery_key_important') %></strong> <%= t('migrations.show.recovery_key_help') %>
                </p>
                <div class="bg-white p-3 rounded-2 mb-2 font-monospace small" style="overflow-wrap: break-word; word-break: break-all;">
                  <%= @migration.rotation_key %>
                </div>
                <button onclick="navigator.clipboard.writeText('<%= @migration.rotation_key %>'); this.textContent='‚úÖ Copied!'; setTimeout(() => this.textContent='üìã <%= j t('migrations.show.copy_clipboard') %>', 2000)"
                        class="btn btn-sm btn-warning text-white">
                  üìã <%= t('migrations.show.copy_clipboard') %>
                </button>
                <details class="mt-3">
                  <summary class="fw-semibold small" style="cursor: pointer; color: #92400e;">
                    <%= t('migrations.show.revert_title') %>
                  </summary>
                  <div class="bg-white p-3 rounded-2 mt-2 small text-body-secondary lh-lg">
                    <p class="mb-2"><%= t('migrations.show.revert_help') %></p>
                    <ol class="ps-3 my-2">
                      <li class="mb-1"><%= t('migrations.show.revert_step1').html_safe %></li>
                      <li class="mb-1"><%= t('migrations.show.revert_step2').html_safe %></li>
                      <li class="mb-1"><%= t('migrations.show.revert_step3') %></li>
                      <li class="mb-1"><%= t('migrations.show.revert_step4').html_safe %></li>
                      <li class="mb-1"><%= t('migrations.show.revert_step5').html_safe %></li>
                      <li><%= t('migrations.show.revert_step6').html_safe %></li>
                    </ol>
                    <p class="text-danger mt-2 mb-0">
                      <strong>Note:</strong> <%= t('migrations.show.revert_warning') %>
                    </p>
                  </div>
                </details>
              </div>
            </details>
          <% end %>

          <%# "Didn't receive the email?" + Technical details (collapsed, only for pending_plc without token) %>
          <% if @migration.pending_plc? && !(@migration.encrypted_plc_token.present? && !@migration.plc_token_expired?) %>
            <details class="mb-3">
              <summary class="fw-semibold small" style="cursor: pointer; color: #92400e;">
                <%= t('migrations.show.didnt_receive_plc') %>
              </summary>
              <div class="bg-warning-subtle border-start border-warning border-4 p-3 rounded-2 mt-2">
                <ul class="small mb-3 ps-3 lh-lg" style="color: #78350f;">
                  <li><%= t('migrations.show.plc_check_spam') %></li>
                  <li><%= t('migrations.show.plc_from_bluesky') %></li>
                  <li><%= t('migrations.show.plc_expires') %></li>
                </ul>
                <% unless @migration.has_old_pds_tokens? %>
                  <p class="small mb-2" style="color: #78350f;">
                    <%= t('migrations.show.plc_new_code_help') %>
                  </p>
                  <form action="<%= reauthenticate_by_token_path(@migration.token) %>" method="post">
                    <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                    <div class="d-flex gap-2">
                      <input type="password" name="password" required
                             autocomplete="current-password"
                             placeholder="<%= t('migrations.show.plc_password_placeholder', handle: @migration.old_handle) %>"
                             class="form-control form-control-sm border-2 border-warning flex-grow-1">
                      <button type="submit"
                              class="btn btn-sm btn-warning text-white fw-semibold text-nowrap">
                        <%= t('migrations.show.request_new_code') %>
                      </button>
                    </div>
                  </form>
                <% end %>
              </div>
            </details>

            <details class="mb-3">
              <summary class="text-body-secondary small fw-medium" style="cursor: pointer;">
                <%= t('migrations.show.technical_details') %>
              </summary>
              <div class="bg-body-tertiary border rounded-3 p-3 mt-2 small text-body-secondary lh-lg">
                <p class="mb-2">
                  <%= t('migrations.show.plc_explanation').html_safe %>
                </p>
                <p class="mb-2">
                  <%= t('migrations.show.plc_irreversible', new_pds: @migration.new_pds_host, old_pds: @migration.old_pds_host).html_safe %>
                </p>
                <p class="mb-0">
                  <%= t('migrations.show.plc_expiry_note') %>
                </p>
              </div>
            </details>
          <% end %>
        <% end %>

      <% end %><%# end of email_verified? if/else %>
    </div>
    </div><%# end card-eurosky %>
  </div>

  <% if show_sidebar %>
    <div class="backup-sidebar">
      <% if @migration.backup_available? %>
        <div class="backup-sidebar-card<%= ' backup-urgent' if @migration.completed? %>">
          <div class="backup-sidebar-header">
            <%= @migration.completed? ? "üì¶ #{t('migrations.show.download_backup')}" : "‚úÖ #{t('migrations.show.backup_ready')}" %>
          </div>
          <div class="backup-sidebar-body">
            <% if @migration.completed? %>
              <p><%= t('migrations.show.backup_download_completed') %></p>
            <% else %>
              <p><%= t('migrations.show.backup_download_ready') %></p>
            <% end %>
            <div class="backup-meta">
              <strong><%= t('migrations.show.size') %></strong> <%= number_to_human_size(@migration.backup_size) %><br>
              <strong><%= t('migrations.show.expires') %></strong> <%= @migration.backup_expires_at.strftime('%b %d, %Y %l:%M %p') %>
            </div>
            <a href="<%= migration_download_backup_path(@migration, token: @migration.token) %>" class="backup-download-btn">
              ‚¨áÔ∏è <%= t('migrations.show.download_button') %>
            </a>
          </div>
        </div>
      <% end %>

      <% if @migration.rotation_key.present? %>
        <div class="backup-sidebar-card" style="border-left-color: #f59e0b;">
          <div class="backup-sidebar-header" style="background: #fef3c7; color: #92400e;">
            üîë <%= t('migrations.show.recovery_key') %>
          </div>
          <div class="backup-sidebar-body">
            <p><%= t('migrations.show.recovery_key_sidebar') %></p>
            <div class="font-monospace" style="font-size: 11px; overflow-wrap: break-word; word-break: break-all; background: #f9fafb; padding: 8px; border-radius: 6px; margin-bottom: 12px;">
              <%= @migration.rotation_key %>
            </div>
            <button onclick="navigator.clipboard.writeText('<%= @migration.rotation_key %>'); this.textContent='‚úÖ Copied!'; setTimeout(() => this.textContent='üìã <%= j t('migrations.show.copy_key') %>', 2000)"
                    class="backup-download-btn" style="border: none; cursor: pointer; width: 100%;">
              üìã <%= t('migrations.show.copy_key') %>
            </button>
          </div>
        </div>
      <% end %>

      <% if @migration.cancellable? && @migration.email_verified? %>
        <div class="backup-sidebar-card" style="border-left-color: #dc2626;">
          <div class="backup-sidebar-header" style="background: #fee2e2; color: #991b1b;">
            <%= t('migrations.show.cancel_migration') %>
          </div>
          <div class="backup-sidebar-body">
            <p><%= t('migrations.show.cancel_help') %></p>
            <form action="<%= request_cancellation_by_token_path(@migration.token) %>" method="post"
                  onsubmit="return confirm('<%= j t('migrations.show.cancel_confirm') %>');">
              <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
              <button type="submit" class="backup-download-btn" style="background: #dc2626; width: 100%; border: none; cursor: pointer;">
                <%= t('migrations.show.cancel_button') %>
              </button>
            </form>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

</div>

<% content_for :scripts do %>
  <script>
    // Align sidebar with card body (below the gradient header)
    (function() {
      var header = document.querySelector('.header-eurosky');
      var sidebar = document.querySelector('.backup-sidebar');
      if (header && sidebar) {
        sidebar.style.marginTop = header.offsetHeight + 'px';
      }
    })();
  </script>
  <% unless @migration.completed? || @migration.failed? %>
  <script>
    (function() {
      var pollUrl = '<%= migration_by_token_path(@migration.token, format: :json) %>';
      var currentStatus = '<%= @migration.status %>';
      var emailVerified = <%= @migration.email_verified? %>;

      function poll() {
        fetch(pollUrl, { headers: { 'Accept': 'application/json' } })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            // Major state transitions that change the page layout ‚Äî full reload
            if (!emailVerified && data.email_verified) {
              window.location.reload();
              return;
            }
            if (data.completed || data.failed) {
              window.location.reload();
              return;
            }
            // Status changed to or from pending_plc/pending_blobs (UI layout changes) ‚Äî full reload
            if (['pending_plc', 'pending_blobs'].includes(data.status) && !['pending_plc', 'pending_blobs'].includes(currentStatus)) {
              window.location.reload();
              return;
            }
            if (['pending_plc', 'pending_blobs'].includes(currentStatus) && !['pending_plc', 'pending_blobs'].includes(data.status)) {
              window.location.reload();
              return;
            }

            // In-place updates for progress
            var bar = document.getElementById('progress-bar');
            var barContainer = document.getElementById('progress-bar-container');
            if (bar && barContainer) {
              bar.style.width = data.progress_percentage + '%';
              bar.textContent = data.progress_percentage + '%';
              barContainer.setAttribute('aria-valuenow', data.progress_percentage);
            }

            var statusText = document.getElementById('status-text');
            if (statusText) {
              statusText.textContent = data.status_humanized;
            }

            var statusValue = document.getElementById('status-value');
            if (statusValue && data.status !== currentStatus) {
              statusValue.className = 'fs-5 fw-semibold status-in-progress';
              statusValue.setAttribute('data-status', data.status);
              currentStatus = data.status;
            }

            var retryInfo = document.getElementById('retry-info');
            if (retryInfo) {
              if (data.job_retrying && data.current_job_step) {
                var stepName = data.current_job_step.replace('Job', '').replace(/([A-Z])/g, ' $1').trim();
                retryInfo.textContent = 'Retry ' + data.current_job_attempt + '/' + data.current_job_max_attempts + ' - ' + stepName;
                retryInfo.style.display = '';
              } else {
                retryInfo.style.display = 'none';
              }
            }

            var queuedNotice = document.getElementById('queued-notice');
            if (queuedNotice) {
              if (data.queued) {
                queuedNotice.style.display = '';
                var queuedReason = document.getElementById('queued-reason');
                if (queuedReason && data.queued_reason) {
                  queuedReason.textContent = data.queued_reason;
                }
              } else {
                queuedNotice.style.display = 'none';
              }
            }

            // Update blob progress metrics
            var blobsCompleted = document.getElementById('blobs-completed');
            if (blobsCompleted && data.blobs_completed !== undefined) {
              blobsCompleted.textContent = data.blobs_completed;
            }
            var blobsTotal = document.getElementById('blobs-total');
            if (blobsTotal && data.blobs_total !== undefined) {
              blobsTotal.textContent = data.blobs_total;
            }
            var bytesTransferred = document.getElementById('bytes-transferred');
            if (bytesTransferred && data.bytes_transferred_formatted) {
              bytesTransferred.textContent = data.bytes_transferred_formatted;
            }
          })
          .catch(function() {
            // Silently ignore fetch errors, will retry on next poll
          });
      }

      setInterval(poll, 10000);
    })();
  </script>
  <% end %>
<% end %>
