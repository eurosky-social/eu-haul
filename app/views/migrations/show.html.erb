<% content_for :title do %>Migration <%= @migration.token %> - <%= EuroskyConfig::SITE_NAME %><% end %>

<% content_for :head do %>
  <style>
    /* Background + centering (matches new.html.erb) */
    body {
      margin: 0;
      padding: 0;
      <% if EuroskyConfig::BACKGROUND_IMAGE_URL.present? %>
      background: url('<%= EuroskyConfig::BACKGROUND_IMAGE_URL %>') no-repeat center center fixed;
      background-size: cover;
      <% else %>
      background: var(--gradient);
      <% end %>
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    <% if EuroskyConfig::BACKGROUND_IMAGE_URL.present? %>
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 0;
    }
    <% end %>

    /* Page-specific layout styles for show.html.erb */
    .page-layout {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: center;
      max-width: 1020px;
      margin: 0 auto;
      padding: 40px 16px;
    }

    .page-layout.has-sidebar {
      display: grid;
      grid-template-columns: minmax(0, 700px) 280px;
      gap: 24px;
      align-items: start;
      justify-content: center;
    }

    .page-layout > .container {
      max-width: 700px;
    }

    .has-sidebar .container {
      max-width: none;
    }

    .backup-sidebar {
      position: sticky;
      top: 20px;
    }

    .backup-sidebar-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      border-left: 4px solid #10b981;
      margin-bottom: 16px;
    }

    .backup-sidebar-card.backup-urgent {
      border-left-color: #3b82f6;
    }

    .backup-sidebar-header {
      background: #d1fae5;
      padding: 16px;
      font-weight: 700;
      font-size: 15px;
      color: #065f46;
    }

    .backup-urgent .backup-sidebar-header {
      background: #dbeafe;
      color: #1e40af;
    }

    .backup-sidebar-body {
      padding: 16px;
    }

    .backup-sidebar-body p {
      font-size: 13px;
      color: #374151;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .backup-sidebar-body .backup-meta {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .backup-sidebar-body .backup-meta strong {
      color: #374151;
    }

    .backup-sidebar-body .backup-download-btn {
      display: block;
      text-align: center;
      padding: 12px 16px;
      background: var(--gradient);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .backup-sidebar-body .backup-download-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .bookmark-notice code {
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: "SF Mono", Monaco, "Courier New", monospace;
      font-size: 13px;
      word-break: break-all;
    }

    .progress-bar-container {
      background: #e5e7eb;
      height: 30px;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      background: var(--gradient);
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      transition: width 0.3s ease;
    }

    .status-completed { color: #10b981; }
    .status-failed { color: #dc2626; }
    .status-in-progress { color: #3b82f6; }

    /* Header-specific overrides: white text on gradient */
    .header-eurosky .status-completed,
    .header-eurosky .status-failed,
    .header-eurosky .status-in-progress {
      color: white !important;
    }

    .header-eurosky .progress-bar-container {
      background: rgba(255, 255, 255, 0.2);
      height: 24px;
      border-radius: 12px;
    }

    .header-eurosky .progress-bar-fill {
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-color);
      font-size: 13px;
      border-radius: 12px;
    }

    .header-eurosky #retry-info {
      color: rgba(255, 255, 200, 0.9) !important;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
    }

    @media (max-width: 1060px) {
      .page-layout.has-sidebar {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .has-sidebar .container {
        display: block;
        max-width: 700px;
      }

      .backup-sidebar {
        position: static;
        width: 100%;
        max-width: 700px;
        margin-bottom: 20px;
        order: -1;
      }
    }

    @media (max-width: 640px) {
      .page-layout {
        padding: 20px 12px;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
<% end %>

<% show_sidebar = @migration.backup_available? || (@migration.rotation_key.present? && @migration.email_verified?) || (@migration.cancellable? && @migration.email_verified?) %>
<div class="page-layout<%= ' has-sidebar' if show_sidebar %>">
  <div class="container">
    <div class="card-eurosky">
    <div class="header-eurosky p-4">
      <% if EuroskyConfig::LOGO_URL.present? %>
        <img src="<%= EuroskyConfig::LOGO_URL %>" alt="<%= EuroskyConfig::SITE_NAME %>" class="header-logo">
      <% end %>

      <% if @migration.email_verified? %>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h1 class="fs-3 mb-0">Migration Status</h1>
          <div class="token-badge" style="font-size: 16px; padding: 4px 12px;"><%= @migration.token %></div>
        </div>

        <div class="d-flex align-items-baseline justify-content-between mb-2">
          <div>
            <span class="small" style="opacity: 0.7;">Status:</span>
            <span id="status-value" class="fw-semibold status-<%= @migration.completed? ? 'completed' : @migration.failed? ? 'failed' : 'in-progress' %>" data-status="<%= @migration.status %>">
              <span id="status-text"><%= @migration.status.humanize %></span>
            </span>
          </div>
          <div id="retry-info" class="small" style="<%= 'display:none;' unless @migration.job_retrying? && @migration.current_job_step %>">
            <% if @migration.job_retrying? && @migration.current_job_step %>
              Retry <%= @migration.current_job_attempt %>/<%= @migration.current_job_max_attempts %> - <%= @migration.current_job_step.gsub('Job', '').humanize %>
            <% end %>
          </div>
        </div>

        <div id="progress-bar-container" class="progress-bar-container" role="progressbar" aria-valuenow="<%= @migration.progress_percentage %>" aria-valuemin="0" aria-valuemax="100">
          <div id="progress-bar" class="progress-bar-fill" style="width: <%= @migration.progress_percentage %>%">
            <%= @migration.progress_percentage %>%
          </div>
        </div>
      <% else %>
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="fs-3 mb-0">Verify Your Email</h1>
          <div class="token-badge" style="font-size: 16px; padding: 4px 12px;"><%= @migration.token %></div>
        </div>
      <% end %>
    </div>

    <div class="p-4">
      <% if flash[:notice] %>
        <div class="alert alert-success border-start border-success border-4 rounded-1 small" role="alert">
          <%= flash[:notice] %>
        </div>
      <% end %>
      <% if flash[:alert] %>
        <div class="alert alert-danger border-start border-danger border-4 rounded-1 small" role="alert">
          <%= flash[:alert] %>
        </div>
      <% end %>

      <% if !@migration.email_verified? %>
        <%# Awaiting email confirmation ‚Äî show code entry form %>
        <div class="text-center pt-2 pb-3">
          <h2 class="fs-4 mb-2 text-dark">Enter Your Verification Code</h2>
          <p class="small text-body-secondary mx-auto mb-0" style="max-width: 480px;">
            We've sent a code to <strong><%= @migration.email %></strong>. Enter it below to start the migration.
          </p>
        </div>

        <%= form_with url: verify_email_path(token: @migration.token), method: :post, local: true do |f| %>
          <div class="form-group">
            <%= label_tag :verification_code, "Verification Code" %>
            <%= text_field_tag :verification_code, nil, required: true, placeholder: "XXX-XXX", autocomplete: "off", maxlength: 7, class: "form-control font-monospace fs-3 text-center text-uppercase", style: "letter-spacing: 4px;" %>
          </div>
          <%= submit_tag "Verify & Start Migration", class: "btn btn-lg btn-gradient w-100 mt-3" %>
        <% end %>

        <div class="alert alert-warning border-start border-warning border-4 rounded-1 py-2 px-3 mt-4 mb-3 small">
          <div class="fw-semibold mb-1" style="color: #92400e;">Didn't receive the email?</div>
          <ul class="mb-0 ps-3 lh-lg" style="color: #78350f;">
            <li>Check your spam or junk folder</li>
            <li>Make sure <strong><%= @migration.email %></strong> is correct</li>
            <li>The email may take a few minutes to arrive</li>
          </ul>
        </div>

      <% else %>

        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>
        <%# Status + progress bar are now in the header above       %>
        <%# Body contains: notices, metrics, actions, help          %>
        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>

        <div id="queued-notice" class="alert alert-primary border-start border-primary border-4 rounded-1 py-2 px-3 mb-3 small" style="<%= 'display:none;' unless @migration.progress_data&.dig('queued') %>">
          <div class="fw-semibold text-primary mb-1">In Queue</div>
          <p id="queued-reason" class="text-primary small mb-0">
            <%= @migration.progress_data&.dig('queued_reason') || 'Waiting for other migrations to finish transferring data' %>
          </p>
          <p class="text-primary small mt-1 mb-0" style="opacity: 0.8;">Your migration will start automatically when a slot opens up.</p>
        </div>

        <% if @migration.progress_data&.dig('legacy_blob_conversion_started_at') && !@migration.progress_data&.dig('legacy_blob_conversion_completed_at') %>
          <div class="alert alert-warning border-start border-warning border-4 rounded-1 py-2 px-3 mb-3 small">
            üîÑ <strong>Converting legacy blob format</strong> ‚Äî this may take a few minutes...
          </div>
        <% elsif @migration.progress_data&.dig('legacy_blobs_converted') == true %>
          <div class="alert alert-success border-start border-success border-4 rounded-1 py-2 px-3 mb-3 small">
            ‚úÖ Legacy blob format converted successfully.
          </div>
        <% end %>

        <% if @migration.pending_blobs? %>
          <% blobs_completed = @migration.progress_data['blobs_completed'].to_i %>
          <% blobs_total = @migration.progress_data['blobs_total'].to_i %>
          <% bytes_transferred = @migration.progress_data['bytes_transferred'].to_i %>
          <% if blobs_total > 0 %>
            <div id="blob-progress-section" class="metrics-grid mb-3">
              <div class="card bg-body-tertiary border">
                <div class="card-body p-3">
                  <div class="small text-body-secondary mb-1">Blobs Uploaded</div>
                  <div class="metric-value">
                    <span id="blobs-completed"><%= blobs_completed %></span>
                    <span class="small fw-normal text-body-secondary">/ <span id="blobs-total"><%= blobs_total %></span> files</span>
                  </div>
                </div>
              </div>
              <div class="card bg-body-tertiary border">
                <div class="card-body p-3">
                  <div class="small text-body-secondary mb-1">Data Transferred</div>
                  <div class="metric-value">
                    <span id="bytes-transferred"><%= number_to_human_size(bytes_transferred) %></span>
                  </div>
                </div>
              </div>
              <% if @migration.progress_data['failed_blobs'].present? %>
                <div class="card bg-body-tertiary border">
                  <div class="card-body p-3">
                    <div class="small text-body-secondary mb-1">Failed</div>
                    <div class="metric-value text-danger">
                      <span id="blobs-failed"><%= @migration.progress_data['failed_blobs'].length %></span>
                      <span class="small fw-normal text-body-secondary">files</span>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% elsif @migration.progress_data['blob_count'].to_i > 0 %>
            <div id="blob-progress-section" class="alert alert-info border-start border-primary border-4 rounded-1 py-2 px-3 mb-3 small">
              Preparing to transfer <strong><%= @migration.progress_data['blob_count'] %></strong> blobs...
            </div>
          <% end %>
        <% end %>

        <% if @migration.pending_download? || @migration.pending_backup? %>
          <div class="alert alert-info border-start border-primary border-4 rounded-1 py-2 px-3 mb-3 small">
            <% if @migration.pending_download? %>
              üì• <strong>Downloading account data</strong> &mdash; downloading your repository + blobs for backup...
            <% else %>
              üì¶ <strong>Creating backup bundle</strong> &mdash; packaging your account data...
            <% end %>
            <% if @migration.progress_data&.dig('download_progress') %>
              <% progress = @migration.progress_data['download_progress'] %>
              <br>Downloaded: <%= progress['downloaded'] %> / <%= progress['total'] %> blobs
              <% if progress['bytes'] %>(<%= number_to_human_size(progress['bytes']) %>)<% end %>
            <% end %>
          </div>
        <% end %>

        <% if @migration.backup_bundle_path.present? && @migration.backup_expired? %>
          <div class="alert alert-danger border-start border-danger border-4 rounded-1 py-2 px-3 mb-3 small">
            ‚ö†Ô∏è <strong>Backup expired</strong> ‚Äî your backup bundle has been deleted from our servers.
          </div>
        <% end %>

        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>
        <%# ZONE 2: PRIMARY CONTENT ‚Äî state-specific hero content   %>
        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>

        <% if @migration.pending_plc? %>
          <hr class="section-divider">
          <% plc_token_submitted = @migration.encrypted_plc_token.present? && !@migration.plc_token_expired? %>

          <% if plc_token_submitted %>
            <div class="text-center py-4">
              <div class="fs-1 mb-2"><span class="spin">‚öô</span></div>
              <h3 class="fs-5 mb-2 text-dark">Updating Your Identity</h3>
              <p class="text-body-secondary lh-lg mx-auto mb-0" style="max-width: 500px;">
                Your confirmation code has been accepted. We're now updating your PLC directory entry
                to point to <strong><%= @migration.new_pds_host %></strong>. This may take a moment.
              </p>
              <p class="text-primary small mt-3 mb-0">
                This page will update automatically. Please don't close this tab.
              </p>
            </div>

          <% else %>
            <div class="text-center mb-3">
              <h3 class="fs-5 mb-1 text-dark">Enter your confirmation code</h3>
              <p class="text-body-secondary small mb-0">
                Check your email for a code from <strong><%= @migration.old_pds_host %></strong> &mdash; it looks like <code class="fs-6">XXXXX-XXXXX</code>
              </p>
            </div>

            <%= form_with url: submit_plc_token_by_token_path(@migration.token), method: :post, local: true do |f| %>
              <div class="form-group">
                <%= label_tag :plc_token, "Confirmation Code" %>
                <%= text_field_tag :plc_token, nil, required: true, placeholder: "XXXXX-XXXXX", autocomplete: "off", class: "form-control font-monospace fs-4 text-center py-3", style: "letter-spacing: 3px;" %>
              </div>
              <%= submit_tag "Complete Migration", class: "btn btn-lg btn-gradient w-100 mt-3", onclick: "return confirm('This will finalize your account migration. This step cannot be undone.\\n\\nAre you sure you want to continue?');" %>
            <% end %>

           
          <% end %>

        <% elsif @migration.completed? %>
          <hr class="section-divider">

          <div class="alert alert-success" role="alert">
            <h3 class="fs-4 mb-3">‚úÖ Migration Completed Successfully!</h3>
            <p class="fs-6">
              <% if @migration.returning_to_existing_pds? %>
                Your account has been successfully migrated back to <strong><%= @migration.new_pds_host %></strong>.
                You can now log in with your handle: <strong><%= @migration.new_handle %></strong>
              <% else %>
                Your account has been successfully migrated to <strong><%= @migration.new_pds_host %></strong>.
                You can now log in with your new handle: <strong><%= @migration.new_handle %></strong>
              <% end %>
            </p>

            <div class="bg-primary-subtle border-start border-primary border-4 p-3 rounded-2 my-3">
              <p class="small mb-0" style="color: #1e40af;">
                ‚úâÔ∏è <strong>We've sent an email to <%= @migration.email %></strong> with your new account password, login instructions, and a link to change your password. Please check your inbox (and spam folder).
              </p>
            </div>

            <% if @migration.rotation_key.present? %>
              <div class="bg-warning-subtle border-start border-warning border-4 p-3 rounded-2 my-4">
                <h4 class="fs-5 mb-2" style="color: #92400e;">‚ö†Ô∏è SAVE YOUR ROTATION KEY NOW!</h4>
                <p class="small mb-3" style="color: #92400e;">
                  <strong>This page will be deleted in 10 minutes for your privacy.</strong><br>
                  Your rotation key is needed for account recovery. Copy it now and store it securely!
                </p>
                <div class="bg-white p-3 rounded-2 my-3 font-monospace small" style="overflow-wrap: break-word; word-break: break-all;">
                  <%= @migration.rotation_key %>
                </div>
                <button onclick="navigator.clipboard.writeText('<%= @migration.rotation_key %>'); this.textContent='‚úÖ Copied!'; setTimeout(() => this.textContent='üìã Copy Rotation Key', 2000)"
                        class="btn btn-warning text-white fw-semibold mb-2">
                  üìã Copy Rotation Key
                </button>
                <p class="small mt-3 mb-0" style="color: #92400e;">
                  ‚úâÔ∏è We've also emailed this key to <strong><%= @migration.email %></strong>
                </p>
              </div>
            <% end %>

            <div class="bg-info-subtle border-start border-primary border-4 p-3 rounded-2 my-3">
              <h4 class="fw-semibold mb-2" style="color: #3730a3;">üîí Privacy Notice</h4>
              <p class="small mb-0" style="color: #3730a3;">
                For your privacy and GDPR compliance, this migration record will be automatically deleted in <strong>10 minutes</strong>.
                Make sure you've saved your rotation key and downloaded your backup before this page disappears!
              </p>
            </div>

            <p class="mt-3 small text-success">
              Your old account credentials have been securely deleted. Welcome <%= @migration.returning_to_existing_pds? ? 'back' : 'to your new home' %>!
            </p>
          </div>

        <% elsif @migration.failed? %>
          <hr class="section-divider">
          <%= render 'migrations/error_details', migration: @migration %>
        <% end %>

        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>
        <%# ZONE 3: SECONDARY / HELP ‚Äî collapsed detail sections    %>
        <%# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê %>

        <% show_zone3 = false %>
        <% show_zone3 = true if @migration.rotation_key.present? && !@migration.completed? && !@migration.pending_download? && !@migration.pending_backup? %>
        <% show_zone3 = true if @migration.pending_plc? && !(@migration.encrypted_plc_token.present? && !@migration.plc_token_expired?) %>

        <% if show_zone3 %>
          <hr class="section-divider">

          <%# Rotation key (collapsible, open by default) %>
          <% if @migration.rotation_key.present? && !@migration.completed? && !@migration.pending_download? && !@migration.pending_backup? %>
            <details class="mb-3">
              <summary class="fw-semibold small" style="cursor: pointer; color: #92400e;">
                üîë Account Recovery Key
              </summary>
              <div class="bg-warning-subtle border-start border-warning border-4 p-3 rounded-2 mt-2">
                <p class="small mb-2" style="color: #92400e;">
                  <strong>IMPORTANT:</strong> Save this rotation key securely. It allows you to revert PLC changes or recover your account.
                </p>
                <div class="bg-white p-3 rounded-2 mb-2 font-monospace small" style="overflow-wrap: break-word; word-break: break-all;">
                  <%= @migration.rotation_key %>
                </div>
                <button onclick="navigator.clipboard.writeText('<%= @migration.rotation_key %>'); this.textContent='‚úÖ Copied!'; setTimeout(() => this.textContent='üìã Copy to Clipboard', 2000)"
                        class="btn btn-sm btn-warning text-white">
                  üìã Copy to Clipboard
                </button>
                <details class="mt-3">
                  <summary class="fw-semibold small" style="cursor: pointer; color: #92400e;">
                    How to use this key to revert changes
                  </summary>
                  <div class="bg-white p-3 rounded-2 mt-2 small text-body-secondary lh-lg">
                    <p class="mb-2">If you need to revert the PLC directory changes, you can use this rotation key:</p>
                    <ol class="ps-3 my-2">
                      <li class="mb-1">Install the <code>goat</code> CLI tool</li>
                      <li class="mb-1">Get your PLC history: <code>goat plc history &lt;your-did&gt;</code></li>
                      <li class="mb-1">Identify the desired historical state (CID)</li>
                      <li class="mb-1">Create reversion operation: <code>goat plc update --prev &lt;cid&gt;</code></li>
                      <li class="mb-1">Sign with your rotation key: <code>goat plc sign</code></li>
                      <li>Submit the signed operation: <code>goat plc submit --did &lt;your-did&gt;</code></li>
                    </ol>
                    <p class="text-danger mt-2 mb-0">
                      <strong>Note:</strong> This is an advanced operation. Only use this if you understand the PLC directory system.
                    </p>
                  </div>
                </details>
              </div>
            </details>
          <% end %>

          <%# "Didn't receive the email?" + Technical details (collapsed, only for pending_plc without token) %>
          <% if @migration.pending_plc? && !(@migration.encrypted_plc_token.present? && !@migration.plc_token_expired?) %>
            <details class="mb-3">
              <summary class="fw-semibold small" style="cursor: pointer; color: #92400e;">
                Didn't receive the email?
              </summary>
              <div class="bg-warning-subtle border-start border-warning border-4 p-3 rounded-2 mt-2">
                <ul class="small mb-3 ps-3 lh-lg" style="color: #78350f;">
                  <li>Check your spam or junk folder</li>
                  <li>The email comes from Bluesky, not from us</li>
                  <li>The code expires after 1 hour</li>
                </ul>
                <% unless @migration.has_old_pds_tokens? %>
                  <p class="small mb-2" style="color: #78350f;">
                    If you need a new code, enter your password below and we'll request one:
                  </p>
                  <form action="<%= reauthenticate_by_token_path(@migration.token) %>" method="post">
                    <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                    <div class="d-flex gap-2">
                      <input type="password" name="password" required
                             autocomplete="current-password"
                             placeholder="Password for <%= @migration.old_handle %>"
                             class="form-control form-control-sm border-2 border-warning flex-grow-1">
                      <button type="submit"
                              class="btn btn-sm btn-warning text-white fw-semibold text-nowrap">
                        Request New Code
                      </button>
                    </div>
                  </form>
                <% end %>
              </div>
            </details>

            <details class="mb-3">
              <summary class="text-body-secondary small fw-medium" style="cursor: pointer;">
                Technical details
              </summary>
              <div class="bg-body-tertiary border rounded-3 p-3 mt-2 small text-body-secondary lh-lg">
                <p class="mb-2">
                  The confirmation code is a <strong>PLC operation token</strong> ‚Äî it authorizes updating your
                  DID document in the PLC directory to point to your new Personal Data Server.
                </p>
                <p class="mb-2">
                  <strong>This is irreversible.</strong> Once submitted, your account identity (DID) will permanently
                  point to <strong><%= @migration.new_pds_host %></strong> instead of <strong><%= @migration.old_pds_host %></strong>.
                </p>
                <p class="mb-0">
                  PLC tokens expire after 1 hour. If yours has expired, you can request a new one.
                </p>
              </div>
            </details>
          <% end %>
        <% end %>

      <% end %><%# end of email_verified? if/else %>
    </div>
    </div><%# end card-eurosky %>
  </div>

  <% if show_sidebar %>
    <div class="backup-sidebar">
      <% if @migration.backup_available? %>
        <div class="backup-sidebar-card<%= ' backup-urgent' if @migration.completed? %>">
          <div class="backup-sidebar-header">
            <%= @migration.completed? ? 'üì¶ Download Your Backup' : '‚úÖ Backup Ready' %>
          </div>
          <div class="backup-sidebar-body">
            <% if @migration.completed? %>
              <p>Your backup bundle will be deleted in <strong>10 minutes</strong>. Download it now!</p>
            <% else %>
              <p>Your account backup is ready! Download it before it expires.</p>
            <% end %>
            <div class="backup-meta">
              <strong>Size:</strong> <%= number_to_human_size(@migration.backup_size) %><br>
              <strong>Expires:</strong> <%= @migration.backup_expires_at.strftime('%b %d, %Y %l:%M %p') %>
            </div>
            <a href="<%= migration_download_backup_path(@migration, token: @migration.token) %>" class="backup-download-btn">
              ‚¨áÔ∏è Download Backup
            </a>
          </div>
        </div>
      <% end %>

      <% if @migration.rotation_key.present? %>
        <div class="backup-sidebar-card" style="border-left-color: #f59e0b;">
          <div class="backup-sidebar-header" style="background: #fef3c7; color: #92400e;">
            üîë Recovery Key
          </div>
          <div class="backup-sidebar-body">
            <p>Save this key securely. It allows you to recover your account.</p>
            <div class="font-monospace" style="font-size: 11px; overflow-wrap: break-word; word-break: break-all; background: #f9fafb; padding: 8px; border-radius: 6px; margin-bottom: 12px;">
              <%= @migration.rotation_key %>
            </div>
            <button onclick="navigator.clipboard.writeText('<%= @migration.rotation_key %>'); this.textContent='‚úÖ Copied!'; setTimeout(() => this.textContent='üìã Copy Key', 2000)"
                    class="backup-download-btn" style="border: none; cursor: pointer; width: 100%;">
              üìã Copy Key
            </button>
          </div>
        </div>
      <% end %>

      <% if @migration.cancellable? && @migration.email_verified? %>
        <div class="backup-sidebar-card" style="border-left-color: #dc2626;">
          <div class="backup-sidebar-header" style="background: #fee2e2; color: #991b1b;">
            Cancel Migration
          </div>
          <div class="backup-sidebar-body">
            <p>Cancel this migration and keep your account on its current server.</p>
            <form action="<%= request_cancellation_by_token_path(@migration.token) %>" method="post"
                  onsubmit="return confirm('Are you sure you want to cancel this migration?\n\nA confirmation link will be sent to your email. The migration will only be cancelled after you click that link.');">
              <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
              <button type="submit" class="backup-download-btn" style="background: #dc2626; width: 100%; border: none; cursor: pointer;">
                Cancel Migration
              </button>
            </form>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

</div>

<% content_for :scripts do %>
  <script>
    // Align sidebar with card body (below the gradient header)
    (function() {
      var header = document.querySelector('.header-eurosky');
      var sidebar = document.querySelector('.backup-sidebar');
      if (header && sidebar) {
        sidebar.style.marginTop = header.offsetHeight + 'px';
      }
    })();
  </script>
  <% unless @migration.completed? || @migration.failed? %>
  <script>
    (function() {
      var pollUrl = '<%= migration_by_token_path(@migration.token, format: :json) %>';
      var currentStatus = '<%= @migration.status %>';
      var emailVerified = <%= @migration.email_verified? %>;

      function poll() {
        fetch(pollUrl, { headers: { 'Accept': 'application/json' } })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            // Major state transitions that change the page layout ‚Äî full reload
            if (!emailVerified && data.email_verified) {
              window.location.reload();
              return;
            }
            if (data.completed || data.failed) {
              window.location.reload();
              return;
            }
            // Status changed to or from pending_plc/pending_blobs (UI layout changes) ‚Äî full reload
            if (['pending_plc', 'pending_blobs'].includes(data.status) && !['pending_plc', 'pending_blobs'].includes(currentStatus)) {
              window.location.reload();
              return;
            }
            if (['pending_plc', 'pending_blobs'].includes(currentStatus) && !['pending_plc', 'pending_blobs'].includes(data.status)) {
              window.location.reload();
              return;
            }

            // In-place updates for progress
            var bar = document.getElementById('progress-bar');
            var barContainer = document.getElementById('progress-bar-container');
            if (bar && barContainer) {
              bar.style.width = data.progress_percentage + '%';
              bar.textContent = data.progress_percentage + '%';
              barContainer.setAttribute('aria-valuenow', data.progress_percentage);
            }

            var statusText = document.getElementById('status-text');
            if (statusText) {
              statusText.textContent = data.status_humanized;
            }

            var statusValue = document.getElementById('status-value');
            if (statusValue && data.status !== currentStatus) {
              statusValue.className = 'fs-5 fw-semibold status-in-progress';
              statusValue.setAttribute('data-status', data.status);
              currentStatus = data.status;
            }

            var retryInfo = document.getElementById('retry-info');
            if (retryInfo) {
              if (data.job_retrying && data.current_job_step) {
                var stepName = data.current_job_step.replace('Job', '').replace(/([A-Z])/g, ' $1').trim();
                retryInfo.textContent = 'Retry ' + data.current_job_attempt + '/' + data.current_job_max_attempts + ' - ' + stepName;
                retryInfo.style.display = '';
              } else {
                retryInfo.style.display = 'none';
              }
            }

            var queuedNotice = document.getElementById('queued-notice');
            if (queuedNotice) {
              if (data.queued) {
                queuedNotice.style.display = '';
                var queuedReason = document.getElementById('queued-reason');
                if (queuedReason && data.queued_reason) {
                  queuedReason.textContent = data.queued_reason;
                }
              } else {
                queuedNotice.style.display = 'none';
              }
            }

            // Update blob progress metrics
            var blobsCompleted = document.getElementById('blobs-completed');
            if (blobsCompleted && data.blobs_completed !== undefined) {
              blobsCompleted.textContent = data.blobs_completed;
            }
            var blobsTotal = document.getElementById('blobs-total');
            if (blobsTotal && data.blobs_total !== undefined) {
              blobsTotal.textContent = data.blobs_total;
            }
            var bytesTransferred = document.getElementById('bytes-transferred');
            if (bytesTransferred && data.bytes_transferred_formatted) {
              bytesTransferred.textContent = data.bytes_transferred_formatted;
            }
          })
          .catch(function() {
            // Silently ignore fetch errors, will retry on next poll
          });
      }

      setInterval(poll, 10000);
    })();
  </script>
  <% end %>
<% end %>
