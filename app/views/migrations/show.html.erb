<% content_for :title do %>Migration <%= @migration.token %> - <%= EuroskyConfig::SITE_NAME %><% end %>

<% content_for :head do %>
  <style>
    /* Page-specific layout styles for show.html.erb */
    .page-layout {
      display: flex;
      justify-content: center;
      max-width: 1020px;
      margin: 0 auto;
      padding: 40px 16px;
    }

    .page-layout.has-sidebar {
      display: grid;
      grid-template-columns: minmax(0, 700px) 280px;
      grid-template-rows: auto 1fr;
      gap: 0 24px;
      justify-content: center;
    }

    .page-layout > .container {
      max-width: 700px;
    }

    .has-sidebar .container {
      grid-column: 1;
      grid-row: 1 / -1;
      display: grid;
      grid-template-rows: subgrid;
      max-width: none;
    }

    .backup-sidebar {
      grid-column: 2;
      grid-row: 2;
      align-self: start;
      position: sticky;
      top: 20px;
    }

    .backup-sidebar-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      border-left: 4px solid #10b981;
      margin-bottom: 16px;
    }

    .backup-sidebar-card.backup-urgent {
      border-left-color: #3b82f6;
    }

    .backup-sidebar-header {
      background: #d1fae5;
      padding: 16px;
      font-weight: 700;
      font-size: 15px;
      color: #065f46;
    }

    .backup-urgent .backup-sidebar-header {
      background: #dbeafe;
      color: #1e40af;
    }

    .backup-sidebar-body {
      padding: 16px;
    }

    .backup-sidebar-body p {
      font-size: 13px;
      color: #374151;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .backup-sidebar-body .backup-meta {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .backup-sidebar-body .backup-meta strong {
      color: #374151;
    }

    .backup-sidebar-body .backup-download-btn {
      display: block;
      text-align: center;
      padding: 12px 16px;
      background: var(--gradient);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .backup-sidebar-body .backup-download-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .bookmark-notice code {
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: "SF Mono", Monaco, "Courier New", monospace;
      font-size: 13px;
      word-break: break-all;
    }

    .progress-bar-container {
      background: #e5e7eb;
      height: 30px;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      background: var(--gradient);
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      transition: width 0.3s ease;
    }

    .status-completed { color: #10b981; }
    .status-failed { color: #dc2626; }
    .status-in-progress { color: #3b82f6; }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
    }

    @media (max-width: 1060px) {
      .page-layout.has-sidebar {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .has-sidebar .container {
        display: block;
        max-width: 700px;
      }

      .backup-sidebar {
        position: static;
        width: 100%;
        max-width: 700px;
        margin-bottom: 20px;
        order: -1;
      }
    }

    @media (max-width: 640px) {
      .page-layout {
        padding: 20px 12px;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
<% end %>

<div class="page-layout<%= ' has-sidebar' if @migration.backup_available? %>">
  <div class="container">
    <div class="card-eurosky">
    <div class="header-eurosky p-4">
      <% if EuroskyConfig::LOGO_URL.present? %>
        <img src="<%= EuroskyConfig::LOGO_URL %>" alt="<%= EuroskyConfig::SITE_NAME %>" class="header-logo">
      <% end %>
      <h1><%= @migration.email_verified? ? 'Migration Status' : 'Verify Your Email' %></h1>
      <div class="token-badge mt-2"><%= @migration.token %></div>
    </div>

    <div class="p-4">
      <% if flash[:notice] %>
        <div class="alert alert-success border-start border-success border-4 rounded-1 small" role="alert">
          <%= flash[:notice] %>
        </div>
      <% end %>
      <% if flash[:alert] %>
        <div class="alert alert-danger border-start border-danger border-4 rounded-1 small" role="alert">
          <%= flash[:alert] %>
        </div>
      <% end %>

      <% if !@migration.email_verified? %>
        <%# Awaiting email confirmation — show code entry form %>
        <div class="text-center pt-4 pb-3">
          <div class="fs-1 mb-2">&#x1F4E7;</div>
          <h2 class="fs-4 mb-2 text-dark">Enter Your Verification Code</h2>
          <p class="fs-6 text-body-secondary lh-lg mx-auto mb-2" style="max-width: 480px;">
            We've sent a verification code to <strong><%= @migration.email %></strong>.
            Enter it below to start the migration.
          </p>
        </div>

        <%= form_with url: verify_email_path(token: @migration.token), method: :post, local: true do |f| %>
          <div class="form-group">
            <%= label_tag :verification_code, "Verification Code" %>
            <%= text_field_tag :verification_code, nil, required: true, placeholder: "XXX-XXX", autocomplete: "off", maxlength: 7, class: "form-control font-monospace fs-3 text-center text-uppercase", style: "letter-spacing: 4px;" %>
          </div>
          <%= submit_tag "Verify & Start Migration", class: "btn btn-lg btn-gradient w-100 mt-3" %>
        <% end %>

        <div class="alert alert-warning border-2 border-warning rounded-3 p-3 mt-4 mb-4">
          <h3 class="fs-6 fw-semibold mb-2" style="color: #92400e;">Didn't receive the email?</h3>
          <ul class="mb-0 ps-3 small lh-lg" style="color: #78350f;">
            <li>Check your spam or junk folder</li>
            <li>Make sure <strong><%= @migration.email %></strong> is correct</li>
            <li>The email may take a few minutes to arrive</li>
          </ul>
        </div>

        <div class="alert alert-info border-start border-info border-4 rounded-1 bookmark-notice" role="note">
          <h3 class="fs-6 fw-semibold mb-2" style="color: #075985;">Bookmark This Page</h3>
          <p class="small mb-2" style="color: #075985;">Save this URL to return and enter your code later:</p>
          <code><%= migration_by_token_url(@migration.token) %></code>
        </div>

      <% else %>


        <div class="mb-4">
          <div class="small text-body-secondary mb-1">Current Status</div>
          <div id="status-value" class="fs-5 fw-semibold status-<%= @migration.completed? ? 'completed' : @migration.failed? ? 'failed' : 'in-progress' %>" data-status="<%= @migration.status %>">
            <span id="status-text"><%= @migration.status.humanize %></span>
            <div id="retry-info" class="small text-warning mt-2" style="<%= 'display:none;' unless @migration.job_retrying? && @migration.current_job_step %>">
              <% if @migration.job_retrying? && @migration.current_job_step %>
                Retry <%= @migration.current_job_attempt %>/<%= @migration.current_job_max_attempts %> - <%= @migration.current_job_step.gsub('Job', '').humanize %>
              <% end %>
            </div>
          </div>
        </div>

        <div id="queued-notice" class="alert alert-primary border-start border-primary border-4 rounded-1 mb-4" style="<%= 'display:none;' unless @migration.progress_data&.dig('queued') %>">
          <div class="fw-semibold text-primary mb-1">In Queue</div>
          <p id="queued-reason" class="text-primary small mb-0">
            <%= @migration.progress_data&.dig('queued_reason') || 'Waiting for other migrations to finish transferring data' %>
          </p>
          <p class="text-primary small mt-2 mb-0" style="opacity: 0.8;">Your migration will start automatically when a slot opens up. This page updates every 10 seconds.</p>
        </div>

        <div class="mb-4">
          <div id="progress-bar-container" class="progress-bar-container" role="progressbar" aria-valuenow="<%= @migration.progress_percentage %>" aria-valuemin="0" aria-valuemax="100">
            <div id="progress-bar" class="progress-bar-fill" style="width: <%= @migration.progress_percentage %>%">
              <%= @migration.progress_percentage %>%
            </div>
          </div>
        </div>

      <% if @migration.progress_data&.dig('legacy_blob_conversion_started_at') && !@migration.progress_data&.dig('legacy_blob_conversion_completed_at') %>
        <div class="card bg-warning-subtle border-warning mb-4">
          <div class="card-body">
            <div class="small text-body-secondary" style="color: #92400e !important;">&#x1F504; Converting Legacy Blob Format</div>
            <p class="small mt-2 mb-0" style="color: #92400e;">
              Pre-2023 blob references are being converted to current format. This may take a few minutes...
            </p>
          </div>
        </div>
      <% elsif @migration.progress_data&.dig('legacy_blobs_converted') == true %>
        <div class="card bg-success-subtle border-success mb-4">
          <div class="card-body">
            <div class="small text-body-secondary" style="color: #065f46 !important;">&#x2705; Legacy Blobs Converted</div>
            <p class="small mt-2 mb-0" style="color: #065f46;">
              Legacy blob format has been successfully converted to current format.
            </p>
          </div>
        </div>
      <% end %>

      <% if @migration.pending_blobs? %>
        <div class="metrics-grid mb-4">
          <% if @migration.progress_data['blobs'].present? %>
            <% blobs = @migration.progress_data['blobs'].values %>
            <% total_blobs = blobs.count %>
            <% total_size = blobs.sum { |b| b['size'].to_i } %>
            <% uploaded_size = blobs.sum { |b| b['uploaded'].to_i } %>

            <div class="card bg-body-tertiary border">
              <div class="card-body p-3">
                <div class="small text-body-secondary mb-1">Blobs Uploaded</div>
                <div class="metric-value">
                  <%= total_blobs %>
                  <span class="small fw-normal text-body-secondary">files</span>
                </div>
              </div>
            </div>

            <div class="card bg-body-tertiary border">
              <div class="card-body p-3">
                <div class="small text-body-secondary mb-1">Data Transferred</div>
                <div class="metric-value">
                  <%= number_to_human_size(uploaded_size) %>
                  <span class="small fw-normal text-body-secondary">/ <%= number_to_human_size(total_size) %></span>
                </div>
              </div>
            </div>

            <% if @migration.estimated_time_remaining %>
              <div class="card bg-body-tertiary border">
                <div class="card-body p-3">
                  <div class="small text-body-secondary mb-1">Time Remaining</div>
                  <div class="metric-value">
                    <%= distance_of_time_in_words(@migration.estimated_time_remaining) %>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>

      <%# Backup Download Section %>
      <% if @migration.pending_download? || @migration.pending_backup? %>
        <div class="card bg-info-subtle border-primary mb-4">
          <div class="card-body">
            <div class="small fw-semibold text-primary">
              <%= @migration.pending_download? ? '&#x1F4E5; Downloading Account Data' : '&#x1F4E6; Creating Backup Bundle' %>
            </div>
            <p class="small text-primary mt-2 mb-0">
              <%= @migration.pending_download? ? 'Downloading your account data (repository + blobs) for backup and migration...' : 'Creating a downloadable backup bundle of your account data...' %>
            </p>
            <% if @migration.progress_data&.dig('download_progress') %>
              <% progress = @migration.progress_data['download_progress'] %>
              <p class="small text-primary mt-2 mb-0">
                Downloaded: <%= progress['downloaded'] %> / <%= progress['total'] %> blobs
                <% if progress['bytes'] %>
                  (<%= number_to_human_size(progress['bytes']) %>)
                <% end %>
              </p>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @migration.backup_bundle_path.present? && @migration.backup_expired? %>
        <div class="card bg-danger-subtle border-danger mb-4">
          <div class="card-body">
            <div class="small fw-semibold text-danger">&#x26A0;&#xFE0F; Backup Expired</div>
            <p class="small text-danger mt-2 mb-0">
              Your backup bundle has expired and has been deleted from our servers.
            </p>
          </div>
        </div>
      <% end %>

      <%# Rotation Key Section %>
      <% if @migration.rotation_key.present? && !@migration.pending_download? && !@migration.pending_backup? %>
        <div class="card bg-warning-subtle border-warning mb-4">
          <div class="card-body">
            <div class="small fw-semibold" style="color: #92400e;">&#x1F511; Account Recovery Key</div>
            <p class="small mt-2 mb-3" style="color: #92400e;">
              <strong>IMPORTANT:</strong> Save this rotation key in a secure location. It allows you to revert PLC changes or recover your account.
            </p>
            <div class="bg-white p-3 rounded-2 mb-3 font-monospace small" style="overflow-wrap: break-word; word-break: break-all;">
              <%= @migration.rotation_key %>
            </div>
            <button onclick="navigator.clipboard.writeText('<%= @migration.rotation_key %>'); this.textContent='&#x2705; Copied!'; setTimeout(() => this.textContent='&#x1F4CB; Copy to Clipboard', 2000)"
                    class="btn btn-warning text-white small">
              &#x1F4CB; Copy to Clipboard
            </button>
            <details class="mt-3">
              <summary class="fw-semibold small" style="cursor: pointer; color: #92400e;">
                How to Use This Key to Revert Changes
              </summary>
              <div class="bg-white p-3 rounded-2 mt-2 small text-body-secondary lh-lg">
                <p class="mb-2">If you need to revert the PLC directory changes, you can use this rotation key:</p>
                <ol class="ps-3 my-2">
                  <li class="mb-1">Install the <code>goat</code> CLI tool</li>
                  <li class="mb-1">Get your PLC history: <code>goat plc history &lt;your-did&gt;</code></li>
                  <li class="mb-1">Identify the desired historical state (CID)</li>
                  <li class="mb-1">Create reversion operation: <code>goat plc update --prev &lt;cid&gt;</code></li>
                  <li class="mb-1">Sign with your rotation key: <code>goat plc sign</code></li>
                  <li>Submit the signed operation: <code>goat plc submit --did &lt;your-did&gt;</code></li>
                </ol>
                <p class="text-danger mt-2 mb-0">
                  <strong>Note:</strong> This is an advanced operation. Only use this if you understand the PLC directory system.
                </p>
              </div>
            </details>
          </div>
        </div>
      <% end %>

      <% if @migration.pending_plc? %>
        <% plc_token_submitted = @migration.encrypted_plc_token.present? && !@migration.plc_token_expired? %>
        <div class="mb-4">
          <% if plc_token_submitted %>
            <%# PLC token has been submitted — show processing state %>
            <div class="text-center pt-4 pb-3">
              <div class="fs-1 mb-2">
                <span class="spin">&#9881;</span>
              </div>
              <h3 class="fs-5 mb-2 text-dark">Updating Your Identity</h3>
              <p class="fs-6 text-body-secondary lh-lg mx-auto mb-0" style="max-width: 500px;">
                Your confirmation code has been accepted. We're now updating your PLC directory entry
                to point to <strong><%= @migration.new_pds_host %></strong>. This may take a moment.
              </p>
            </div>
            <div class="alert alert-primary border-2 border-primary rounded-3 text-center">
              <p class="text-primary small mb-0">
                This page will update automatically when the process completes. Please don't close this tab.
              </p>
            </div>
          <% else %>
            <%# No PLC token yet (or expired) — show the entry form %>
            <div class="text-center py-3">
              <div class="fs-1 mb-2">&#x1F4E7;</div>
              <h3 class="fs-5 mb-2 text-dark">Almost done! Check your email</h3>
              <p class="fs-6 text-body-secondary lh-lg mx-auto mb-0" style="max-width: 500px;">
                Your account data has been copied to your new server. To finalize the move,
                we need you to enter a <strong>confirmation code</strong> that Bluesky sent to your email.
              </p>
            </div>

            <div class="alert alert-info border-2 border-primary rounded-3 p-3 mb-3">
              <h4 class="fs-6 fw-semibold mb-2 text-primary">What to look for</h4>
              <p class="small text-dark lh-lg mb-2">
                You should have received an email with the subject <strong>"PLC update requested"</strong>.
                It contains a <strong>confirmation code</strong> that looks like this:
              </p>
              <div class="bg-white p-3 rounded-2 text-center font-monospace fs-5 text-dark my-2" style="letter-spacing: 3px;">
                XXXXX-XXXXX
              </div>
              <p class="small text-body-secondary mt-2 mb-0">
                Copy that code and paste it below.
              </p>
            </div>

            <%= form_with url: submit_plc_token_by_token_path(@migration.token), method: :post, local: true do |f| %>
              <div class="form-group">
                <%= label_tag :plc_token, "Confirmation Code" %>
                <%= text_field_tag :plc_token, nil, required: true, placeholder: "XXXXX-XXXXX", autocomplete: "off", class: "form-control font-monospace fs-5 text-center", style: "letter-spacing: 2px;" %>
              </div>

              <%= submit_tag "Complete Migration", class: "btn btn-lg btn-gradient w-100 mt-3", onclick: "return confirm('This will finalize your account migration. This step cannot be undone.\\n\\nAre you sure you want to continue?');" %>
            <% end %>

            <div class="alert alert-warning border-2 border-warning rounded-3 p-3 mt-3">
              <h4 class="fs-6 fw-semibold mb-2" style="color: #92400e;">Didn't receive the email?</h4>
              <ul class="small mb-3 ps-3 lh-lg" style="color: #78350f;">
                <li>Check your spam or junk folder</li>
                <li>The email comes from Bluesky, not from us</li>
                <li>The code expires after 1 hour</li>
              </ul>
              <% unless @migration.has_old_pds_tokens? %>
                <p class="small mb-3" style="color: #78350f;">
                  If you need a new code, enter your password below and we'll request one:
                </p>
                <form action="<%= reauthenticate_by_token_path(@migration.token) %>" method="post">
                  <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                  <div class="d-flex gap-2">
                    <input type="password" name="password" required
                           autocomplete="current-password"
                           placeholder="Password for <%= @migration.old_handle %>"
                           class="form-control form-control-sm border-2 border-warning flex-grow-1">
                    <button type="submit"
                            class="btn btn-warning text-white fw-semibold small text-nowrap">
                      Request New Code
                    </button>
                  </div>
                </form>
              <% end %>
            </div>

            <details class="mt-3">
              <summary class="text-body-secondary small fw-medium" style="cursor: pointer;">
                Technical details
              </summary>
              <div class="bg-body-tertiary border rounded-3 p-3 mt-2 small text-body-secondary lh-lg">
                <p class="mb-2">
                  The confirmation code is a <strong>PLC operation token</strong> — it authorizes updating your
                  DID document in the PLC directory to point to your new Personal Data Server.
                </p>
                <p class="mb-2">
                  <strong>This is irreversible.</strong> Once submitted, your account identity (DID) will permanently
                  point to <strong><%= @migration.new_pds_host %></strong> instead of <strong><%= @migration.old_pds_host %></strong>.
                </p>
                <p class="mb-0">
                  PLC tokens expire after 1 hour. If yours has expired, you can request a new one.
                </p>
              </div>
            </details>
          <% end %>
        </div>
      <% end %>

      <% if @migration.completed? %>
        <div class="alert alert-success" role="alert">
          <h3 class="fs-4 mb-3">&#x2705; Migration Completed Successfully!</h3>
          <p class="fs-6">
            <% if @migration.returning_to_existing_pds? %>
              Your account has been successfully migrated back to <strong><%= @migration.new_pds_host %></strong>.
              You can now log in with your handle: <strong><%= @migration.new_handle %></strong>
            <% else %>
              Your account has been successfully migrated to <strong><%= @migration.new_pds_host %></strong>.
              You can now log in with your new handle: <strong><%= @migration.new_handle %></strong>
            <% end %>
          </p>

          <%# CRITICAL: Rotation Key Warning %>
          <% if @migration.rotation_key.present? %>
            <div class="bg-warning-subtle border-start border-warning border-4 p-3 rounded-2 my-4">
              <h4 class="fs-5 mb-2" style="color: #92400e;">&#x26A0;&#xFE0F; SAVE YOUR ROTATION KEY NOW!</h4>
              <p class="small mb-3" style="color: #92400e;">
                <strong>This page will be deleted in 10 minutes for your privacy.</strong><br>
                Your rotation key is needed for account recovery. Copy it now and store it securely!
              </p>
              <div class="bg-white p-3 rounded-2 my-3 font-monospace small" style="overflow-wrap: break-word; word-break: break-all;">
                <%= @migration.rotation_key %>
              </div>
              <button onclick="navigator.clipboard.writeText('<%= @migration.rotation_key %>'); this.textContent='&#x2705; Copied!'; setTimeout(() => this.textContent='&#x1F4CB; Copy Rotation Key', 2000)"
                      class="btn btn-warning text-white fw-semibold mb-2">
                &#x1F4CB; Copy Rotation Key
              </button>
              <p class="small mt-3 mb-0" style="color: #92400e;">
                &#x2709;&#xFE0F; We've also emailed this key to <strong><%= @migration.email %></strong>
              </p>
            </div>
          <% end %>

          <%# Auto-deletion warning %>
          <div class="bg-info-subtle border-start border-primary border-4 p-3 rounded-2 my-3">
            <h4 class="fw-semibold mb-2" style="color: #3730a3;">&#x1F512; Privacy Notice</h4>
            <p class="small mb-0" style="color: #3730a3;">
              For your privacy and GDPR compliance, this migration record will be automatically deleted in <strong>10 minutes</strong>.
              Make sure you've saved your rotation key and downloaded your backup before this page disappears!
            </p>
          </div>

          <p class="mt-3 small text-success">
            Your old account credentials have been securely deleted. Welcome <%= @migration.returning_to_existing_pds? ? 'back' : 'to your new home' %>!
          </p>
        </div>
      <% end %>

      <% if @migration.failed? %>
        <%= render 'migrations/error_details', migration: @migration %>
      <% end %>

      <% end %><%# end of email_verified? if/else %>
    </div>
    </div><%# end card-eurosky %>
  </div>

  <% if @migration.backup_available? %>
    <div class="backup-sidebar">
      <div class="backup-sidebar-card<%= ' backup-urgent' if @migration.completed? %>">
        <div class="backup-sidebar-header">
          <%= @migration.completed? ? '&#x1F4E6; Download Your Backup' : '&#x2705; Backup Ready' %>
        </div>
        <div class="backup-sidebar-body">
          <% if @migration.completed? %>
            <p>Your backup bundle will be deleted in <strong>10 minutes</strong>. Download it now!</p>
          <% else %>
            <p>Your account backup is ready! Download it before it expires.</p>
          <% end %>
          <div class="backup-meta">
            <strong>Size:</strong> <%= number_to_human_size(@migration.backup_size) %><br>
            <strong>Expires:</strong> <%= @migration.backup_expires_at.strftime('%b %d, %Y %l:%M %p') %>
          </div>
          <a href="<%= migration_download_backup_path(@migration, token: @migration.token) %>" class="backup-download-btn">
            &#x2B07;&#xFE0F; Download Backup
          </a>
        </div>
      </div>

      <%# Email verified — show normal progress tracking %>
        <div class="backup-sidebar-card">
          <div class="backup-sidebar-header">
          Bookmark This Page
          </div>
          <div class="backup-sidebar-body">
          <p>Save this URL to track your migration progress:</p>
          <code><%= migration_by_token_url(@migration.token) %></code>
          </div>
        </div>

    </div>
  <% end %>

</div>

<% content_for :scripts do %>
  <% unless @migration.completed? || @migration.failed? %>
  <script>
    (function() {
      var pollUrl = '<%= migration_by_token_path(@migration.token, format: :json) %>';
      var currentStatus = '<%= @migration.status %>';
      var emailVerified = <%= @migration.email_verified? %>;

      function poll() {
        fetch(pollUrl, { headers: { 'Accept': 'application/json' } })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            // Major state transitions that change the page layout — full reload
            if (!emailVerified && data.email_verified) {
              window.location.reload();
              return;
            }
            if (data.completed || data.failed) {
              window.location.reload();
              return;
            }
            // Status changed to or from pending_plc (UI layout changes) — full reload
            if (data.status === 'pending_plc' && currentStatus !== 'pending_plc') {
              window.location.reload();
              return;
            }
            if (currentStatus === 'pending_plc' && data.status !== 'pending_plc') {
              window.location.reload();
              return;
            }

            // In-place updates for progress
            var bar = document.getElementById('progress-bar');
            var barContainer = document.getElementById('progress-bar-container');
            if (bar && barContainer) {
              bar.style.width = data.progress_percentage + '%';
              bar.textContent = data.progress_percentage + '%';
              barContainer.setAttribute('aria-valuenow', data.progress_percentage);
            }

            var statusText = document.getElementById('status-text');
            if (statusText) {
              statusText.textContent = data.status_humanized;
            }

            var statusValue = document.getElementById('status-value');
            if (statusValue && data.status !== currentStatus) {
              statusValue.className = 'fs-5 fw-semibold status-in-progress';
              statusValue.setAttribute('data-status', data.status);
              currentStatus = data.status;
            }

            var retryInfo = document.getElementById('retry-info');
            if (retryInfo) {
              if (data.job_retrying && data.current_job_step) {
                var stepName = data.current_job_step.replace('Job', '').replace(/([A-Z])/g, ' $1').trim();
                retryInfo.textContent = 'Retry ' + data.current_job_attempt + '/' + data.current_job_max_attempts + ' - ' + stepName;
                retryInfo.style.display = '';
              } else {
                retryInfo.style.display = 'none';
              }
            }

            var queuedNotice = document.getElementById('queued-notice');
            if (queuedNotice) {
              if (data.queued) {
                queuedNotice.style.display = '';
                var queuedReason = document.getElementById('queued-reason');
                if (queuedReason && data.queued_reason) {
                  queuedReason.textContent = data.queued_reason;
                }
              } else {
                queuedNotice.style.display = 'none';
              }
            }
          })
          .catch(function() {
            // Silently ignore fetch errors, will retry on next poll
          });
      }

      setInterval(poll, 10000);
    })();
  </script>
  <% end %>
<% end %>
